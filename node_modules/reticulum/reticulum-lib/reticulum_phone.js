function HashTable(t){this.length=0,this.items={};for(var e in t)t.hasOwnProperty(e)&&(this.items[e]=t[e],this.length++);this.setItem=function(t,e){var s;return this.hasItem(t)?s=this.items[t]:this.length++,this.items[t]=e,s},this.getItem=function(t){return this.hasItem(t)?this.items[t]:null},this.hasItem=function(t){return this.items.hasOwnProperty(t)},this.removeItem=function(t){return this.hasItem(t)?(previous=this.items[t],this.length--,delete this.items[t],previous):null},this.keys=function(){var t=[];for(var e in this.items)this.hasItem(e)&&t.push(e);return t},this.values=function(){var t=[];for(var e in this.items)this.hasItem(e)&&t.push(this.items[e]);return t},this.each=function(t){for(var e in this.items)this.hasItem(e)&&t(e,this.items[e])},this.clear=function(){this.items={},this.length=0}}var UI={};UI.enable=function(t){},UI.disable=function(t){},UI.setLabel=function(t){};var Utils={TOKEN_ALPHA:0,TOKEN_ALPHANUMERIC:1,TOKEN_NUMERIC_8:2,TOKEN_NUMERIC_16:3,TOKEN_NUMERIC_32:4,TOKEN_NUMERIC_10:10,token:function(t,e){e="undefined"!=typeof e?e:1;for(var s="",i="abcdefghijklmnopqrstuvwxyz",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=Math.pow(2,e+1),n=0;t>n;n++)s+=e===Utils.TOKEN_ALPHA?i.charAt((1e3*Math.random()|0)%i.length):e===Utils.TOKEN_ALPHANUMERIC?r.charAt((1e3*Math.random()|0)%r.length):e===Utils.TOKEN_NUMERIC_10?(10*Math.random()|0).toString(10):(Math.random()*a|0).toString(a);return s},uuid:function(){var t=Utils.token(36,Utils.TOKEN_NUMERIC_16);return t[8]="-",t[13]="-",t[18]="-",t[23]="-",t},newUUID:function(){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,s="x"===t?e:3&e|8;return s.toString(16)});return t},unquote:function(t){if(void 0===t||null===t)return"";if(0===t.length)return"";var e='"';return t[0]===e&&t[t.length-1]===e?t.slice(1,t.length-1):t},md5cycle:function(t,e){var s=t[0],i=t[1],r=t[2],a=t[3];s=Utils.ff(s,i,r,a,e[0],7,-680876936),a=Utils.ff(a,s,i,r,e[1],12,-389564586),r=Utils.ff(r,a,s,i,e[2],17,606105819),i=Utils.ff(i,r,a,s,e[3],22,-1044525330),s=Utils.ff(s,i,r,a,e[4],7,-176418897),a=Utils.ff(a,s,i,r,e[5],12,1200080426),r=Utils.ff(r,a,s,i,e[6],17,-1473231341),i=Utils.ff(i,r,a,s,e[7],22,-45705983),s=Utils.ff(s,i,r,a,e[8],7,1770035416),a=Utils.ff(a,s,i,r,e[9],12,-1958414417),r=Utils.ff(r,a,s,i,e[10],17,-42063),i=Utils.ff(i,r,a,s,e[11],22,-1990404162),s=Utils.ff(s,i,r,a,e[12],7,1804603682),a=Utils.ff(a,s,i,r,e[13],12,-40341101),r=Utils.ff(r,a,s,i,e[14],17,-1502002290),i=Utils.ff(i,r,a,s,e[15],22,1236535329),s=Utils.gg(s,i,r,a,e[1],5,-165796510),a=Utils.gg(a,s,i,r,e[6],9,-1069501632),r=Utils.gg(r,a,s,i,e[11],14,643717713),i=Utils.gg(i,r,a,s,e[0],20,-373897302),s=Utils.gg(s,i,r,a,e[5],5,-701558691),a=Utils.gg(a,s,i,r,e[10],9,38016083),r=Utils.gg(r,a,s,i,e[15],14,-660478335),i=Utils.gg(i,r,a,s,e[4],20,-405537848),s=Utils.gg(s,i,r,a,e[9],5,568446438),a=Utils.gg(a,s,i,r,e[14],9,-1019803690),r=Utils.gg(r,a,s,i,e[3],14,-187363961),i=Utils.gg(i,r,a,s,e[8],20,1163531501),s=Utils.gg(s,i,r,a,e[13],5,-1444681467),a=Utils.gg(a,s,i,r,e[2],9,-51403784),r=Utils.gg(r,a,s,i,e[7],14,1735328473),i=Utils.gg(i,r,a,s,e[12],20,-1926607734),s=Utils.hh(s,i,r,a,e[5],4,-378558),a=Utils.hh(a,s,i,r,e[8],11,-2022574463),r=Utils.hh(r,a,s,i,e[11],16,1839030562),i=Utils.hh(i,r,a,s,e[14],23,-35309556),s=Utils.hh(s,i,r,a,e[1],4,-1530992060),a=Utils.hh(a,s,i,r,e[4],11,1272893353),r=Utils.hh(r,a,s,i,e[7],16,-155497632),i=Utils.hh(i,r,a,s,e[10],23,-1094730640),s=Utils.hh(s,i,r,a,e[13],4,681279174),a=Utils.hh(a,s,i,r,e[0],11,-358537222),r=Utils.hh(r,a,s,i,e[3],16,-722521979),i=Utils.hh(i,r,a,s,e[6],23,76029189),s=Utils.hh(s,i,r,a,e[9],4,-640364487),a=Utils.hh(a,s,i,r,e[12],11,-421815835),r=Utils.hh(r,a,s,i,e[15],16,530742520),i=Utils.hh(i,r,a,s,e[2],23,-995338651),s=Utils.ii(s,i,r,a,e[0],6,-198630844),a=Utils.ii(a,s,i,r,e[7],10,1126891415),r=Utils.ii(r,a,s,i,e[14],15,-1416354905),i=Utils.ii(i,r,a,s,e[5],21,-57434055),s=Utils.ii(s,i,r,a,e[12],6,1700485571),a=Utils.ii(a,s,i,r,e[3],10,-1894986606),r=Utils.ii(r,a,s,i,e[10],15,-1051523),i=Utils.ii(i,r,a,s,e[1],21,-2054922799),s=Utils.ii(s,i,r,a,e[8],6,1873313359),a=Utils.ii(a,s,i,r,e[15],10,-30611744),r=Utils.ii(r,a,s,i,e[6],15,-1560198380),i=Utils.ii(i,r,a,s,e[13],21,1309151649),s=Utils.ii(s,i,r,a,e[4],6,-145523070),a=Utils.ii(a,s,i,r,e[11],10,-1120210379),r=Utils.ii(r,a,s,i,e[2],15,718787259),i=Utils.ii(i,r,a,s,e[9],21,-343485551),t[0]=Utils.add32(s,t[0]),t[1]=Utils.add32(i,t[1]),t[2]=Utils.add32(r,t[2]),t[3]=Utils.add32(a,t[3])},cmn:function(t,e,s,i,r,a){return e=Utils.add32(Utils.add32(e,t),Utils.add32(i,a)),Utils.add32(e<<r|e>>>32-r,s)},ff:function(t,e,s,i,r,a,n){return Utils.cmn(e&s|~e&i,t,e,r,a,n)},gg:function(t,e,s,i,r,a,n){return Utils.cmn(e&i|s&~i,t,e,r,a,n)},hh:function(t,e,s,i,r,a,n){return Utils.cmn(e^s^i,t,e,r,a,n)},ii:function(t,e,s,i,r,a,n){return Utils.cmn(s^(e|~i),t,e,r,a,n)},md51:function(t){var e,s=t.length,i=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=t.length;e+=64)Utils.md5cycle(i,Utils.md5blk(t.substring(e-64,e)));t=t.substring(e-64);var r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<t.length;e++)r[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(r[e>>2]|=128<<(e%4<<3),e>55)for(md5cycle(i,r),e=0;16>e;e++)r[e]=0;return r[14]=8*s,Utils.md5cycle(i,r),i},md5blk:function(t){var e,s=[];for(e=0;64>e;e+=4)s[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return s},hex_chr:"0123456789abcdef".split(""),rhex:function(t){for(var e="",s=0;4>s;s++)e+=Utils.hex_chr[t>>8*s+4&15]+Utils.hex_chr[t>>8*s&15];return e},hex:function(t){for(var e=0;e<t.length;e++)t[e]=Utils.rhex(t[e]);return t.join("")},md5:function(t){return MD5.hexdigest(t)},add32:function(t,e){return t+e&4294967295}},MD5=function(){var t=0,e="",s=8,i=function(t,e){var s=(65535&t)+(65535&e),i=(t>>16)+(e>>16)+(s>>16);return i<<16|65535&s},r=function(t,e){return t<<e|t>>>32-e},a=function(t){for(var e=[],i=(1<<s)-1,r=0;r<t.length*s;r+=s)e[r>>5]|=(t.charCodeAt(r/s)&i)<<r%32;return e},n=function(t){for(var e="",i=(1<<s)-1,r=0;r<32*t.length;r+=s)e+=String.fromCharCode(t[r>>5]>>>r%32&i);return e},o=function(e){for(var s=t?"0123456789ABCDEF":"0123456789abcdef",i="",r=0;r<4*e.length;r++)i+=s.charAt(e[r>>2]>>r%4*8+4&15)+s.charAt(e[r>>2]>>r%4*8&15);return i},u=function(t){for(var s,i,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a="",n=0;n<4*t.length;n+=3)for(s=(t[n>>2]>>8*(n%4)&255)<<16|(t[n+1>>2]>>8*((n+1)%4)&255)<<8|t[n+2>>2]>>8*((n+2)%4)&255,i=0;4>i;i++)a+=8*n+6*i>32*t.length?e:r.charAt(s>>6*(3-i)&63);return a},c=function(t,e,s,a,n,o){return i(r(i(i(e,t),i(a,o)),n),s)},h=function(t,e,s,i,r,a,n){return c(e&s|~e&i,t,e,r,a,n)},l=function(t,e,s,i,r,a,n){return c(e&i|s&~i,t,e,r,a,n)},R=function(t,e,s,i,r,a,n){return c(e^s^i,t,e,r,a,n)},I=function(t,e,s,i,r,a,n){return c(s^(e|~i),t,e,r,a,n)},S=function(t,e){t[e>>5]|=128<<e%32,t[(e+64>>>9<<4)+14]=e;for(var s,r,a,n,o=1732584193,u=-271733879,c=-1732584194,S=271733878,E=0;E<t.length;E+=16)s=o,r=u,a=c,n=S,o=h(o,u,c,S,t[E+0],7,-680876936),S=h(S,o,u,c,t[E+1],12,-389564586),c=h(c,S,o,u,t[E+2],17,606105819),u=h(u,c,S,o,t[E+3],22,-1044525330),o=h(o,u,c,S,t[E+4],7,-176418897),S=h(S,o,u,c,t[E+5],12,1200080426),c=h(c,S,o,u,t[E+6],17,-1473231341),u=h(u,c,S,o,t[E+7],22,-45705983),o=h(o,u,c,S,t[E+8],7,1770035416),S=h(S,o,u,c,t[E+9],12,-1958414417),c=h(c,S,o,u,t[E+10],17,-42063),u=h(u,c,S,o,t[E+11],22,-1990404162),o=h(o,u,c,S,t[E+12],7,1804603682),S=h(S,o,u,c,t[E+13],12,-40341101),c=h(c,S,o,u,t[E+14],17,-1502002290),u=h(u,c,S,o,t[E+15],22,1236535329),o=l(o,u,c,S,t[E+1],5,-165796510),S=l(S,o,u,c,t[E+6],9,-1069501632),c=l(c,S,o,u,t[E+11],14,643717713),u=l(u,c,S,o,t[E+0],20,-373897302),o=l(o,u,c,S,t[E+5],5,-701558691),S=l(S,o,u,c,t[E+10],9,38016083),c=l(c,S,o,u,t[E+15],14,-660478335),u=l(u,c,S,o,t[E+4],20,-405537848),o=l(o,u,c,S,t[E+9],5,568446438),S=l(S,o,u,c,t[E+14],9,-1019803690),c=l(c,S,o,u,t[E+3],14,-187363961),u=l(u,c,S,o,t[E+8],20,1163531501),o=l(o,u,c,S,t[E+13],5,-1444681467),S=l(S,o,u,c,t[E+2],9,-51403784),c=l(c,S,o,u,t[E+7],14,1735328473),u=l(u,c,S,o,t[E+12],20,-1926607734),o=R(o,u,c,S,t[E+5],4,-378558),S=R(S,o,u,c,t[E+8],11,-2022574463),c=R(c,S,o,u,t[E+11],16,1839030562),u=R(u,c,S,o,t[E+14],23,-35309556),o=R(o,u,c,S,t[E+1],4,-1530992060),S=R(S,o,u,c,t[E+4],11,1272893353),c=R(c,S,o,u,t[E+7],16,-155497632),u=R(u,c,S,o,t[E+10],23,-1094730640),o=R(o,u,c,S,t[E+13],4,681279174),S=R(S,o,u,c,t[E+0],11,-358537222),c=R(c,S,o,u,t[E+3],16,-722521979),u=R(u,c,S,o,t[E+6],23,76029189),o=R(o,u,c,S,t[E+9],4,-640364487),S=R(S,o,u,c,t[E+12],11,-421815835),c=R(c,S,o,u,t[E+15],16,530742520),u=R(u,c,S,o,t[E+2],23,-995338651),o=I(o,u,c,S,t[E+0],6,-198630844),S=I(S,o,u,c,t[E+7],10,1126891415),c=I(c,S,o,u,t[E+14],15,-1416354905),u=I(u,c,S,o,t[E+5],21,-57434055),o=I(o,u,c,S,t[E+12],6,1700485571),S=I(S,o,u,c,t[E+3],10,-1894986606),c=I(c,S,o,u,t[E+10],15,-1051523),u=I(u,c,S,o,t[E+1],21,-2054922799),o=I(o,u,c,S,t[E+8],6,1873313359),S=I(S,o,u,c,t[E+15],10,-30611744),c=I(c,S,o,u,t[E+6],15,-1560198380),u=I(u,c,S,o,t[E+13],21,1309151649),o=I(o,u,c,S,t[E+4],6,-145523070),S=I(S,o,u,c,t[E+11],10,-1120210379),c=I(c,S,o,u,t[E+2],15,718787259),u=I(u,c,S,o,t[E+9],21,-343485551),o=i(o,s),u=i(u,r),c=i(c,a),S=i(S,n);return[o,u,c,S]},E=function(t,e){var i=a(t);i.length>16&&(i=S(i,t.length*s));for(var r=new Array(16),n=new Array(16),o=0;16>o;o++)r[o]=909522486^i[o],n[o]=1549556828^i[o];var u=S(r.concat(a(e)),512+e.length*s);return S(n.concat(u),640)},m={hexdigest:function(t){return o(S(a(t),t.length*s))},b64digest:function(t){return u(S(a(t),t.length*s))},hash:function(t){return n(S(a(t),t.length*s))},hmac_hexdigest:function(t,e){return o(E(t,e))},hmac_b64digest:function(t,e){return u(E(t,e))},hmac_hash:function(t,e){return n(E(t,e))},test:function(){return"900150983cd24fb0d6963f7d28e17f72"===MD5.hexdigest("abc")}};return m}(),Digest=function(){};Digest.createAuthorization=function(t,e,s){if("basic"==t.challenge.type.toLowerCase());else{if("digest"==t.challenge.type.toLowerCase()){var i=e.uri.toString(),r=Utils.token(8,Utils.TOKEN_NUMERIC_16),a="";s.cnonce=r,s.nc++;for(var n=0;n<8-(s.nc+"").length;n++)a+="0";var o=Utils.md5(s.user+":"+s.realm+":"+s.password),u=Utils.md5(e.method+":"+i),c=Utils.md5(o+":"+t.challenge.nonce+":"+a+s.nc+":"+s.cnonce+":"+t.challenge.qop+":"+u),h=t.challenge.type+" ";return h+='username="'+s.user+'", ',h+='realm="'+s.realm+'", ',h+='nonce="'+t.challenge.nonce+'", ',h+='uri="'+i+'", ',h+='qop="'+t.challenge.qop+'", ',h+='nc="'+a+s.nc+'", ',h+='cnonce="'+s.cnonce+'", ',h+='response="'+c+'", ',h+='opaque="'+t.challenge.opaque+'", '}console.log("Error. Invalid auth method "+t.challenge.type)}return null},Reticulum={},Reticulum.Parser={},Reticulum.Parser.Arrays={},Reticulum.Parser.Hashes={},Reticulum.Parser.Enum={SIP_HDR_ACCEPT:0,SIP_HDR_ACCEPT_CONTACT:1,SIP_HDR_ACCEPT_ENCODING:2,SIP_HDR_ACCEPT_LANGUAGE:3,SIP_HDR_ACCEPT_RESOURCE_PRIORITY:4,SIP_HDR_ALERT_INFO:5,SIP_HDR_ALLOW:6,SIP_HDR_ALLOW_EVENTS:7,SIP_HDR_ANSWER_MODE:8,SIP_HDR_AUTHENTICATION_INFO:9,SIP_HDR_AUTHORIZATION:10,SIP_HDR_CALL_ID:11,SIP_HDR_CALL_INFO:12,SIP_HDR_CONTACT:13,SIP_HDR_CONTENT_DISPOSITION:14,SIP_HDR_CONTENT_ENCODING:15,SIP_HDR_CONTENT_LANGUAGE:16,SIP_HDR_CONTENT_LENGTH:17,SIP_HDR_CONTENT_TYPE:18,SIP_HDR_CSEQ:19,SIP_HDR_DATE:20,SIP_HDR_ENCRYPTION:21,SIP_HDR_ERROR_INFO:22,SIP_HDR_EVENT:23,SIP_HDR_EXPIRES:24,SIP_HDR_FLOW_TIMER:25,SIP_HDR_FROM:26,SIP_HDR_HIDE:27,SIP_HDR_HISTORY_INFO:28,SIP_HDR_IDENTITY:29,SIP_HDR_IDENTITY_INFO:30,SIP_HDR_IN_REPLY_TO:31,SIP_HDR_JOIN:32,SIP_HDR_MAX_BREADTH:33,SIP_HDR_MAX_FORWARDS:34,SIP_HDR_MIME_VERSION:35,SIP_HDR_MIN_EXPIRES:36,SIP_HDR_MIN_SE:37,SIP_HDR_ORGANIZATION:38,SIP_HDR_P_ACCESS_NETWORK_INFO:39,SIP_HDR_P_ANSWER_STATE:40,SIP_HDR_P_ASSERTED_IDENTITY:41,SIP_HDR_P_ASSOCIATED_URI:42,SIP_HDR_P_CALLED_PARTY_ID:43,SIP_HDR_P_CHARGING_FUNCTION_ADDRESSES:44,SIP_HDR_P_CHARGING_VECTOR:45,SIP_HDR_P_DCS_TRACE_PARTY_ID:46,SIP_HDR_P_DCS_OSPS:47,SIP_HDR_P_DCS_BILLING_INFO:48,SIP_HDR_P_DCS_LAES:49,SIP_HDR_P_DCS_REDIRECT:50,SIP_HDR_P_EARLY_MEDIA:51,SIP_HDR_P_MEDIA_AUTHORIZATION:52,SIP_HDR_P_PREFERRED_IDENTITY:53,SIP_HDR_P_PROFILE_KEY:54,SIP_HDR_P_REFUSED_URI_LIST:55,SIP_HDR_P_SERVED_USER:56,SIP_HDR_P_USER_DATABASE:57,SIP_HDR_P_VISITED_NETWORK_ID:58,SIP_HDR_PATH:59,SIP_HDR_PERMISSION_MISSING:60,SIP_HDR_PRIORITY:61,SIP_HDR_PRIV_ANSWER_MODE:62,SIP_HDR_PRIVACY:63,SIP_HDR_PROXY_AUTHENTICATE:64,SIP_HDR_PROXY_AUTHORIZATION:65,SIP_HDR_PROXY_REQUIRE:66,SIP_HDR_RACK:67,SIP_HDR_REASON:68,SIP_HDR_RECORD_ROUTE:69,SIP_HDR_REFER_SUB:70,SIP_HDR_REFER_TO:71,SIP_HDR_REFERRED_BY:72,SIP_HDR_REJECT_CONTACT:73,SIP_HDR_REPLACES:74,SIP_HDR_REPLY_TO:75,SIP_HDR_REQUEST_DISPOSITION:76,SIP_HDR_REQUIRE:77,SIP_HDR_RESOURCE_PRIORITY:78,SIP_HDR_RESPONSE_KEY:79,SIP_HDR_RETRY_AFTER:80,SIP_HDR_ROUTE:81,SIP_HDR_RSEQ:82,SIP_HDR_SECURITY_CLIENT:83,SIP_HDR_SECURITY_SERVER:84,SIP_HDR_SECURITY_VERIFY:85,SIP_HDR_SERVER:86,SIP_HDR_SERVICE_ROUTE:87,SIP_HDR_SESSION_EXPIRES:88,SIP_HDR_SIP_ETAG:89,SIP_HDR_SIP_IF_MATCH:90,SIP_HDR_SUBJECT:91,SIP_HDR_SUBSCRIPTION_STATE:92,SIP_HDR_SUPPORTED:93,SIP_HDR_TARGET_DIALOG:94,SIP_HDR_TIMESTAMP:95,SIP_HDR_TO:96,SIP_HDR_TRIGGER_CONSENT:97,SIP_HDR_UNSUPPORTED:98,SIP_HDR_USER_AGENT:99,SIP_HDR_VIA:100,SIP_HDR_WARNING:101,SIP_HDR_WWW_AUTHENTICATE:102,SIP_HDR_NONE:-1},Reticulum.Parser.Hashes.Headers={Accept:Reticulum.Parser.Enum.SIP_HDR_ACCEPT,"Accept-Contact":Reticulum.Parser.Enum.SIP_HDR_ACCEPT_CONTACT,"Accept-Encoding":Reticulum.Parser.Enum.SIP_HDR_ACCEPT_ENCODING,"Accept-Language":Reticulum.Parser.Enum.SIP_HDR_ACCEPT_LANGUAGE,"Accept-Resource-Priority":Reticulum.Parser.Enum.SIP_HDR_ACCEPT_RESOURCE_PRIORITY,"Alert-Info":Reticulum.Parser.Enum.SIP_HDR_ALERT_INFO,Allow:Reticulum.Parser.Enum.SIP_HDR_ALLOW,"Allow-Events":Reticulum.Parser.Enum.SIP_HDR_ALLOW_EVENTS,"Answer-Mode":Reticulum.Parser.Enum.SIP_HDR_ANSWER_MODE,"Authentication-Info":Reticulum.Parser.Enum.SIP_HDR_AUTHENTICATION_INFO,Authorization:Reticulum.Parser.Enum.SIP_HDR_AUTHORIZATION,"Call-ID":Reticulum.Parser.Enum.SIP_HDR_CALL_ID,"Call-Info":Reticulum.Parser.Enum.SIP_HDR_CALL_INFO,Contact:Reticulum.Parser.Enum.SIP_HDR_CONTACT,"Content-Disposition":Reticulum.Parser.Enum.SIP_HDR_CONTENT_DISPOSITION,"Content-Encoding":Reticulum.Parser.Enum.SIP_HDR_CONTENT_ENCODING,"Content-Language":Reticulum.Parser.Enum.SIP_HDR_CONTENT_LANGUAGE,"Content-Length":Reticulum.Parser.Enum.SIP_HDR_CONTENT_LENGTH,"Content-Type":Reticulum.Parser.Enum.SIP_HDR_CONTENT_TYPE,CSeq:Reticulum.Parser.Enum.SIP_HDR_CSEQ,Date:Reticulum.Parser.Enum.SIP_HDR_DATE,Encryption:Reticulum.Parser.Enum.SIP_HDR_ENCRYPTION,"Error-Info":Reticulum.Parser.Enum.SIP_HDR_ERROR_INFO,Event:Reticulum.Parser.Enum.SIP_HDR_EVENT,Expires:Reticulum.Parser.Enum.SIP_HDR_EXPIRES,"Flow-Timer":Reticulum.Parser.Enum.SIP_HDR_FLOW_TIMER,From:Reticulum.Parser.Enum.SIP_HDR_FROM,Hide:Reticulum.Parser.Enum.SIP_HDR_HIDE,"History-Info":Reticulum.Parser.Enum.SIP_HDR_HISTORY_INFO,Identity:Reticulum.Parser.Enum.SIP_HDR_IDENTITY,"Identity-Info":Reticulum.Parser.Enum.SIP_HDR_IDENTITY_INFO,"In-Reply-To":Reticulum.Parser.Enum.SIP_HDR_IN_REPLY_TO,Join:Reticulum.Parser.Enum.SIP_HDR_JOIN,"Max-Breadth":Reticulum.Parser.Enum.SIP_HDR_MAX_BREADTH,"Max-Forwards":Reticulum.Parser.Enum.SIP_HDR_MAX_FORWARDS,"MIME-Version":Reticulum.Parser.Enum.SIP_HDR_MIME_VERSION,"Min-Expires":Reticulum.Parser.Enum.SIP_HDR_MIN_EXPIRES,"Min-SE":Reticulum.Parser.Enum.SIP_HDR_MIN_SE,Organization:Reticulum.Parser.Enum.SIP_HDR_ORGANIZATION,"P-Access-Network-Info":Reticulum.Parser.Enum.SIP_HDR_P_ACCESS_NETWORK_INFO,"P-Answer-State":Reticulum.Parser.Enum.SIP_HDR_P_ANSWER_STATE,"P-Asserted-Identity":Reticulum.Parser.Enum.SIP_HDR_P_ASSERTED_IDENTITY,"P-Associated-URI":Reticulum.Parser.Enum.SIP_HDR_P_ASSOCIATED_URI,"P-Called-Party-ID":Reticulum.Parser.Enum.SIP_HDR_P_CALLED_PARTY_ID,"P-Charging-Function-Addresses":Reticulum.Parser.Enum.SIP_HDR_P_CHARGING_FUNCTION_ADDRESSES,"P-Charging-Vector":Reticulum.Parser.Enum.SIP_HDR_P_CHARGING_VECTOR,"P-DCS-Trace-Party-ID":Reticulum.Parser.Enum.SIP_HDR_P_DCS_TRACE_PARTY_ID,"P-DCS-OSPS":Reticulum.Parser.Enum.SIP_HDR_P_DCS_OSPS,"P-DCS-Billing-Info":Reticulum.Parser.Enum.SIP_HDR_P_DCS_BILLING_INFO,"P-DCS-LAES":Reticulum.Parser.Enum.SIP_HDR_P_DCS_LAES,"P-DCS-Redirect":Reticulum.Parser.Enum.SIP_HDR_P_DCS_REDIRECT,"P-Early-Media":Reticulum.Parser.Enum.SIP_HDR_P_EARLY_MEDIA,"P-Media-Authorization":Reticulum.Parser.Enum.SIP_HDR_P_MEDIA_AUTHORIZATION,"P-Preferred-Identity":Reticulum.Parser.Enum.SIP_HDR_P_PREFERRED_IDENTITY,"P-Profile-Key":Reticulum.Parser.Enum.SIP_HDR_P_PROFILE_KEY,"P-Refused-URI-List":Reticulum.Parser.Enum.SIP_HDR_P_REFUSED_URI_LIST,"P-Server-User":Reticulum.Parser.Enum.SIP_HDR_P_SERVED_USER,"P-User-Database":Reticulum.Parser.Enum.SIP_HDR_P_USER_DATABASE,"P-Visited-Network-ID":Reticulum.Parser.Enum.SIP_HDR_P_VISITED_NETWORK_ID,Path:Reticulum.Parser.Enum.SIP_HDR_PATH,"Permission-Missing":Reticulum.Parser.Enum.SIP_HDR_PERMISSION_MISSING,Priority:Reticulum.Parser.Enum.SIP_HDR_PRIORITY,"Priv-Answer-Mode":Reticulum.Parser.Enum.SIP_HDR_PRIV_ANSWER_MODE,Privacy:Reticulum.Parser.Enum.SIP_HDR_PRIVACY,"Proxy-Authenticate":Reticulum.Parser.Enum.SIP_HDR_PROXY_AUTHENTICATE,"Proxy-Authorization":Reticulum.Parser.Enum.SIP_HDR_PROXY_AUTHORIZATION,"Proxy-Require":Reticulum.Parser.Enum.SIP_HDR_PROXY_REQUIRE,Rack:Reticulum.Parser.Enum.SIP_HDR_RACK,Reason:Reticulum.Parser.Enum.SIP_HDR_REASON,"Record-Route":Reticulum.Parser.Enum.SIP_HDR_RECORD_ROUTE,"Refer-Sub":Reticulum.Parser.Enum.SIP_HDR_REFER_SUB,"Refer-To":Reticulum.Parser.Enum.SIP_HDR_REFER_TO,"Refered-By":Reticulum.Parser.Enum.SIP_HDR_REFERRED_BY,"Reject-Contact":Reticulum.Parser.Enum.SIP_HDR_REJECT_CONTACT,Replaces:Reticulum.Parser.Enum.SIP_HDR_REPLACES,"Reply-To":Reticulum.Parser.Enum.SIP_HDR_REPLY_TO,"Request-Disposition":Reticulum.Parser.Enum.SIP_HDR_REQUEST_DISPOSITION,Require:Reticulum.Parser.Enum.SIP_HDR_REQUIRE,"Resource-Priority":Reticulum.Parser.Enum.SIP_HDR_RESOURCE_PRIORITY,"Response-Key":Reticulum.Parser.Enum.SIP_HDR_RESPONSE_KEY,"Retry-After":Reticulum.Parser.Enum.SIP_HDR_RETRY_AFTER,Route:Reticulum.Parser.Enum.SIP_HDR_ROUTE,RSeq:Reticulum.Parser.Enum.SIP_HDR_RSEQ,"Security-Client":Reticulum.Parser.Enum.SIP_HDR_SECURITY_CLIENT,"Security-Server":Reticulum.Parser.Enum.SIP_HDR_SECURITY_SERVER,"Security-Verify":Reticulum.Parser.Enum.SIP_HDR_SECURITY_VERIFY,Server:Reticulum.Parser.Enum.SIP_HDR_SERVER,"Service-Route":Reticulum.Parser.Enum.SIP_HDR_SERVICE_ROUTE,"Session-Expires":Reticulum.Parser.Enum.SIP_HDR_SESSION_EXPIRES,"SIP-ETag":Reticulum.Parser.Enum.SIP_HDR_SIP_ETAG,"SIP-If-Match":Reticulum.Parser.Enum.SIP_HDR_SIP_IF_MATCH,Subject:Reticulum.Parser.Enum.SIP_HDR_SUBJECT,"Subscription-State":Reticulum.Parser.Enum.SIP_HDR_SUBSCRIPTION_STATE,Supported:Reticulum.Parser.Enum.SIP_HDR_SUPPORTED,"Target-Dialog":Reticulum.Parser.Enum.SIP_HDR_TARGET_DIALOG,Timestamp:Reticulum.Parser.Enum.SIP_HDR_TIMESTAMP,To:Reticulum.Parser.Enum.SIP_HDR_TO,"Trigger-Consent":Reticulum.Parser.Enum.SIP_HDR_TRIGGER_CONSENT,Unsupported:Reticulum.Parser.Enum.SIP_HDR_UNSUPPORTED,"User-Agent":Reticulum.Parser.Enum.SIP_HDR_USER_AGENT,Via:Reticulum.Parser.Enum.SIP_HDR_VIA,Warning:Reticulum.Parser.Enum.SIP_HDR_WARNING,"WWW-Authenticate":Reticulum.Parser.Enum.SIP_HDR_WWW_AUTHENTICATE},Reticulum.Parser.Arrays.Headers=["Accept","Accept-Contact","Accept-Encoding","Accept-Language","Accept-Resource-Priority","Alert-Info","Allow","Allow-Events","Answer-Mode","Authentication-Info","Authorization","Call-ID","Call-Info","Contact","Content-Disposition","Content-Encoding","Content-Language","Content-Length","Content-Type","CSeq","Date","Encryption","Error-Info","Event","Expires","Flow-Timer","From","Hide","History-Info","Identity","Identity-Info","In-Reply-To","Join","Max-Breadth","Max-Forwards","MIME-Version","Min-Expires","Min-SE","Organization","P-Access-Network-Info","P-Answer-State","P-Asserted-Identity","P-Associated-URI","P-Called-Party-ID","P-Charging-Function-Addresses","P-Charging-Vector","P-DCS-Trace-Party-ID","P-DCS-OSPS","P-DCS-Billing-Info","P-DCS-LAES","P-DCS-Redirect","P-Early-Media","P-Media-Authorization","P-Preferred-Identity","P-Profile-Key","P-Refused-URI-List","P-Server-User","P-User-Database","P-Visited-Network-ID","Path","Permission-Missing","Priority","Priv-Answer-Mode","Privacy","Proxy-Authenticate","Proxy-Authorization","Proxy-Require","Rack","Reason","Record-Route","Refer-Sub","Refer-To","Refered-By","Reject-Contact","Replaces","Reply-To","Request-Disposition","Require","Resource-Priority","Response-Key","Retry-After","Route","RSeq","Security-Client","Security-Server","Security-Verify","Server","Service-Route","Session-Expires","SIP-ETag","SIP-If-Match","Subject","Subscription-State","Supported","Target-Dialog","Timestamp","To","Trigger-Consent","Unsupported","User-Agent","Via","Warning","WWW-Authenticate"];var sipmsg1=["INVITE sip:bob:bobspassword@biloxi.com:10050;parameters?headers SIP/2.0","Via: SIP/2.0/UDP pc33.atlanta.com;branch=z9hG4bKnashds8","To: Bob <sip:bob@biloxi.com>","From: Alice <sip:alice@atlanta.com>;tag=1928301774","Call-ID: a84b4c76e66710","CSeq: 314159 INVITE","Max-Forwards: 70","Contact: <sip:alice@pc33.atlanta.com>","Content-Type: application/pkcs7-mime; smime-type=enveloped-data; name=smime.p7m","Content-Disposition: attachment; filename=smime.p7m handling=required","","1234567890"].join("\r\n"),sipmsg2=["REGISTER sip:registrar.biloxi.com SIP/2.0","Via: SIP/2.0/UDP bobspc.biloxi.com:5060;branch=z9hG4bKnashds7","Max-Forwards: 70","To: Bob <sip:bob@biloxi.com>","From: Bob <sip:bob@biloxi.com>;tag=456248","Call-ID: 843817637684230@998sdasdh09","CSeq: 1826 REGISTER","Contact: <sip:bob@192.0.2.4>","Expires: 7200","Content-Length: 0","",""].join("\r\n"),sipmsg3=["SIP/2.0 200 OK","Via: SIP/2.0/UDP bobspc.biloxi.com:5060;branch=z9hG4bKnashds7 ;received=192.0.2.4","To: Bob <sip:bob@biloxi.com>;tag=2493k59kd","From: Bob <sip:bob@biloxi.com>;tag=456248","Call-ID: 843817637684230@998sdasdh09","CSeq: 1826 REGISTER","Contact: <sip:bob@192.0.2.4>","Expires: 7200","Content-Length: 0","",""].join("\r\n"),sipmsg4=["SIP/2.0 200 OK","Via: SIP/2.0/UDP pc33.atlanta.com;branch=z9hG4bKhjhs8ass877 ;received=192.0.2.4","To: <sip:carol@chicago.com>;tag=93810874","From: Alice <sip:alice@atlanta.com>;tag=1928301774","Call-ID: a84b4c76e66710","CSeq: 63104 OPTIONS","Contact: <sip:carol@chicago.com>","Contact: <mailto:carol@chicago.com>","Allow: INVITE, ACK, CANCEL, OPTIONS, BYE","Accept: application/sdp","Accept-Encoding: gzip","Accept-Language: en","Supported: foo","Content-Type: application/sdp","Content-Length: 274","",""].join("\r\n"),sipmsg5=["INVITE sip:bob@u2.biloxi.com SIP/2.0","Record-Route: <sip:p2.biloxi.com;lr>","Record-Route: <sip:p1.atlanta.com;lr>","From: Alice <sip:alice@atlanta.com>;tag=1354385","To: Bob <sip:bob@biloxi.com>","Call-ID: xyz","CSeq: 1 INVITE","Contact: <sip:alice@u1.atlanta.com>","",""].join("\r\n"),sipmsg6=["SIP/2.0 180 Ringing","Record-Route: <sip:p2.biloxi.com;lr>","Record-Route: <sip:p1.atlanta.com;lr>","From: Alice <sip:alice@atlanta.com>;tag=1354385","To: Bob <sip:bob@biloxi.com>","Call-ID: xyz","CSeq: 1 INVITE","Contact: <sip:bob@u2.biloxy.com>","",""].join("\r\n"),sipmsg7=["INVITE sip:bob@u2.biloxi.com SIP/2.0","Record-Route: <sip:p2.biloxi.com;lr>","Record-Route: <sip:p1.atlanta.com;lr>",'From: "Alice Ana" <sip:alice@atlanta.com>;tag=1354385','To: "Bob" <sip:bob@biloxi.com>',"Call-ID: xyz","CSeq: 1 INVITE","Contact: <sip:alice@u1.atlanta.com>","",""].join("\r\n");Reticulum.Parser.TestFormatURI="sip:user:password@host:port;uri-parameters?headers",Reticulum.Parser.getHeaderId=function(t){if(0===t.length)return this.Enum.SIP_HDR_NONE;var e=Reticulum.Parser.Hashes.Headers[t];if(e)return e;switch(t[0].toLowerCase()){case"a":return this.Enum.SIP_HDR_ACCEPT_CONTACT;case"b":return this.Enum.SIP_HDR_REFERRED_BY;case"c":return this.Enum.SIP_HDR_CONTENT_TYPE;case"d":return this.Enum.SIP_HDR_REQUEST_DISPOSITION;case"e":return this.Enum.SIP_HDR_CONTENT_ENCODING;case"f":return this.Enum.SIP_HDR_FROM;case"i":return this.Enum.SIP_HDR_CALL_ID;case"j":return this.Enum.SIP_HDR_REJECT_CONTACT;case"k":return this.Enum.SIP_HDR_SUPPORTED;case"l":return this.Enum.SIP_HDR_CONTENT_LENGTH;case"m":return this.Enum.SIP_HDR_CONTACT;case"n":return this.Enum.SIP_HDR_IDENTITY_INFO;case"o":return this.Enum.SIP_HDR_EVENT;case"r":return this.Enum.SIP_HDR_REFER_TO;case"s":return this.Enum.SIP_HDR_SUBJECT;case"t":return this.Enum.SIP_HDR_TO;case"u":return this.Enum.SIP_HDR_ALLOW_EVENTS;case"v":return this.Enum.SIP_HDR_VIA;case"x":return this.Enum.SIP_HDR_SESSION_EXPIRES;case"y":return this.Enum.SIP_HDR_IDENTITY;default:return this.Enum.SIP_HDR_NONE}},Reticulum.Parser.isCommaSeparatedHeader=function(t){switch(t){case this.Enum.SIP_HDR_ACCEPT:case this.Enum.SIP_HDR_ACCEPT_CONTACT:case this.Enum.SIP_HDR_ACCEPT_ENCODING:case this.Enum.SIP_HDR_ACCEPT_LANGUAGE:case this.Enum.SIP_HDR_ACCEPT_RESOURCE_PRIORITY:case this.Enum.SIP_HDR_ALERT_INFO:case this.Enum.SIP_HDR_ALLOW:case this.Enum.SIP_HDR_ALLOW_EVENTS:case this.Enum.SIP_HDR_AUTHENTICATION_INFO:case this.Enum.SIP_HDR_CALL_INFO:case this.Enum.SIP_HDR_CONTACT:case this.Enum.SIP_HDR_CONTENT_ENCODING:case this.Enum.SIP_HDR_CONTENT_LANGUAGE:case this.Enum.SIP_HDR_ERROR_INFO:case this.Enum.SIP_HDR_HISTORY_INFO:case this.Enum.SIP_HDR_IN_REPLY_TO:case this.Enum.SIP_HDR_P_ASSERTED_IDENTITY:case this.Enum.SIP_HDR_P_ASSOCIATED_URI:case this.Enum.SIP_HDR_P_EARLY_MEDIA:case this.Enum.SIP_HDR_P_MEDIA_AUTHORIZATION:case this.Enum.SIP_HDR_P_PREFERRED_IDENTITY:case this.Enum.SIP_HDR_P_REFUSED_URI_LIST:case this.Enum.SIP_HDR_P_VISITED_NETWORK_ID:case this.Enum.SIP_HDR_PATH:case this.Enum.SIP_HDR_PERMISSION_MISSING:case this.Enum.SIP_HDR_PROXY_REQUIRE:case this.Enum.SIP_HDR_REASON:case this.Enum.SIP_HDR_RECORD_ROUTE:case this.Enum.SIP_HDR_REJECT_CONTACT:case this.Enum.SIP_HDR_REQUEST_DISPOSITION:case this.Enum.SIP_HDR_REQUIRE:case this.Enum.SIP_HDR_RESOURCE_PRIORITY:case this.Enum.SIP_HDR_ROUTE:case this.Enum.SIP_HDR_SECURITY_CLIENT:case this.Enum.SIP_HDR_SECURITY_SERVER:case this.Enum.SIP_HDR_SECURITY_VERIFY:case this.Enum.SIP_HDR_SERVICE_ROUTE:case this.Enum.SIP_HDR_SUPPORTED:case this.Enum.SIP_HDR_TRIGGER_CONSENT:case this.Enum.SIP_HDR_UNSUPPORTED:case this.Enum.SIP_HDR_VIA:case this.Enum.SIP_HDR_WARNING:return!0;default:return!1}},Reticulum.Parser.parseHost=function(t){var e=new Reticulum.SIP.Host,s=/\[([0-9a-f:]+)\][:]*([0-9]*)/,i=s.exec(t);if(e.isipv6=!0,null===i){var r=/([^:]+)[:]*([0-9]*)/;if(i=r.exec(t),null===i)return null;e.isipv6=!1}return e.name=i[1],e.port=i[2],e},Reticulum.Parser.parseURI=function(t){var e=new Reticulum.SIP.URI,s=/([^:]+):([^@:]*)[:]*([^@]*)@([^;? ]+)([^?]*)([^]*)/,i=s.exec(t),r="";if(null!==i&&i.length>5){if(e.scheme=i[1],e.user=i[2],e.password=i[3],r=i[4],e._params_string=i[5],e.headers=i[6],e.host=this.parseHost(r),null===e.host)return null}else{var a=/([^:]+):\/?\/?([^;? ]+)([^?]*)([^]*)/;if(i=a.exec(t),null===i)return null;if(e.scheme=i[1],r=i[2],e._params_string=i[3],e.headers=i[4],e.host=this.parseHost(r),null===e.host)return null}return e.host.port&&""!==e.host.port&&(e.port=parseInt(e.host.port)),e.params=this.parseParams(e._params_string),e.raw=t,e},Reticulum.Parser.parseAddress=function(t){var e=new Reticulum.SIP.Address,s=/[ \t\r\n]*([^\t\r\n<]*)[ \t\r\n]*<([^>]+)>([^]*)/,i=s.exec(t);if(e.value=t,null===i){var r=/([^;]+)([^]*)/;if(i=r.exec(t),null===i)return null;e.auri=i[1],e._params_string=i[2]}else e.dname=Utils.unquote(i[1].trim()).trim(),e.auri=i[2],e._params_string=i[3];return e.uri=this.parseURI(e.auri),null===e.uri?null:(e.params=this.parseParams(e._params_string),e)},Reticulum.Parser.parseContact=function(t){var e=new Reticulum.SIP.Contact;return e.address=this.parseAddress(t),null!==e.address&&null!==e.address.params&&(e.expires=e.address.params.expires),e},Reticulum.Parser.parseCSeq=function(t){var e=new Reticulum.SIP.CSeq,s=/([0-9]+)[ \t\r\n]+([^ \t\r\n]+)/,i=s.exec(t);if(null===i)return null;var r=i[1];return e.method=i[2],null===r?null:(e.number=parseInt(r),e)},Reticulum.Parser.parseContentType=function(t){var e=new Reticulum.SIP.ContentType,s=/([ \t\r\n]*)([^ \t\r\n;\/]+)[ \t\r\n]*\/[ \t\r\n]*([^ \t\r\n;]+)([^]*)/,i=s.exec(t);return e.type=i[2],e.subtype=i[3],e._params_string=i[4],e.params=this.parseParams(e._params_string),e},Reticulum.Parser.parseVia=function(t){var e=new Reticulum.SIP.Via,s=/SIP[  \t\r\n]*\/[ \t\r\n]*2.0[ \t\r\n]*\/([ \t\r\n]*[A-Z]+)[ \t\r\n]*([^; \t\r\n]+)[ \t\r\n]*([^]*)/,i=s.exec(t);return null===i?null:(e.transport=i[1],e.sentby=i[2],e._params_string=i[3],e.value=t,e.host=this.parseHost(e.sentby),null===e.host?null:(e.host.port&&""!==e.host.port&&(e.port=parseInt(e.host.port)),e.params=this.parseParams(e._params_string),e.branch=e.params.branch,null===e.branch?null:e))},Reticulum.Parser.parseParams=function(t){var e={};return t.trim().split(";").forEach(function(t){var s=t.trim();""!==s&&(s=s.split("="),s.length<2&&s.push(""),e[s[0]]=s[1])}),e},Reticulum.Parser.stringifyParams=function(t){var e="";for(var s in t)e+=";"+s,""!==t[s]&&(e+="="+t[s]);return e},Reticulum.Parser.parseParam=function(t,e){var s=";[ 	\r\n]*"+e+"[ 	\r\n]*=[ 	\r\n]*([^ 	\r\n;]+)",i=new RegExp(s),r=i.exec(t);return null===r?null:r[1]},Reticulum.Parser.parseAuthenticate=function(t){var e={},s=t.indexOf(" ");return e.type=t.substr(0,s),t.substr(s+1).split(",").forEach(function(t){var s=t.trim().split("="),i=Utils.unquote(s[1]);switch(s[0]){case"realm":e.realm=i;break;case"domain":e.domain=i;break;case"nonce":e.nonce=i;break;case"opaque":e.opaque=i;break;case"stale":e.stale=i;break;case"algorithm":e.algorithm=i;break;case"qop":e.qop=i;break;case"qop-options":e.qop_options=i;break;case"auth-param":e.auth_param=i}}),e},Reticulum.Parser.parseAuthorization=function(t,e){var s={},i=t.indexOf(" ");return s.type=t.substr(0,i),t.substr(i+1).split(",").forEach(function(t){var e=t.trim().split("="),i=Utils.unquote(e[1]);switch(e[0]){case"realm":s.realm=i;break;case"nonce":s.nonce=i;break;case"response":s.response=i;break;case"username":s.username=i;break;case"uri":s.uri=i;break;case"nc":s.nc=i;break;case"cnonce":s.cnonce=i;break;case"qop":s.qop=i}}),s},Reticulum.Parser.parse=function(t){var e=new Reticulum.SIP.Message,s=t,i=/([^ \t\r\n]+) ([^ \t\r\n]+) ([^\r\n]*)[\r]*[\n]/,r=i.exec(t);if(null===r)return null;if(e.tag=Utils.token(10,Utils.TOKEN_NUMERIC_16),e.raw=t,e.isRequest=!1,r.length<4)return null;if("SIP/2.0"==r[3]&&(e.isRequest=!0),e.isRequest){if(e.method=r[1],e.remoteURI=r[2],e.version=r[3],e.uri=this.parseURI(r[2]),!e.uri)return null}else if(e.version=r[1],e.statusCode=parseInt(r[2]),e.reason=r[3],!e.statusCode)return null;var a=0,n=s.length;n-=r[0].length,a=r[0].length;var o,u,c,h,l={};l.p=o=u=null,l.l=c=h=0;for(var R=!1,I=!1,S=this.Enum.SIP_HDR_NONE;n>0;a++,n--)switch(s[a]){case" ":case"	":h=0,++c;break;case"\r":++c;break;case"\n":if(++c,!h++)break;++a,--n;default:if(h||","==s[a]&&R&&!I){if(!l.l)return null;if(e.addHeader(s.substr(l.p,l.l),S,s.substr(u?u:a,u?a-u-c:0)),!h){u=null;break}if(u!=o&&e.addHeader(s.substr(l.p,l.l),S,s.substr(o?o:a,o?a-o-c:0)),h>1)return e.pos=a,e;R=!1,l.p=null,u=o=null,h=0}if(l.p||(l.p=a,l.l=0,c=0),!l.l){if(":"!=s[a]){c=0;break}if(l.l=Math.max(a-l.p-c,0),!l.l)return null;S=this.getHeaderId(s.substr(l.p,l.l)),R=this.isCommaSeparatedHeader(S);break}u||(I=!1,u=a),o||(o=a),'"'==s[a]&&(I=!I),c=0}return e};var parser=Reticulum.Parser,Media=function(t,e){this.to=null,this.uri=null,this.localSDP=null,this.remoteSDP=null;this.gotUserMedia=function(t){console.log("got media",t)},this.gotDescription=function(t){console.log("got description")},this.handleOffer=null,this.handleAnswer=null,this.gotRemoteStream=function(t){console.log("got remote stream")}};Media.prototype.setVideoContainersIDs=function(t,e){},Media.prototype.getMedia=function(){},Media.prototype.getLocalSDP=function(){return"local sdp"},Media.prototype.start=function(){},Media.prototype.makeOffer=function(t,e){console.log("make offer");var s=this;s.localSDP="description.sdp",s.to=t,s.uri=e,s.handleOffer(s.to,s.uri),s.to=null,s.uri=null},Media.prototype.makeAnswer=function(){var t=this;t.localSDP="description.sdp",
t.handleAnswer()},Media.prototype.setRemoteSDP=function(t){this.remoteSDP=t},Media.prototype.log=function(t){},Media.prototype.startAudio=function(){},Media.prototype.stopAudio=function(){};var Transport=function(t,e,s,i){this.app=t,i||(i="wss"),this.ws=null,this.protocol=i,this.server=e,this.port=s};Transport.prototype.isSecure=function(){return"wss"===this.protocol},Transport.prototype.isReliable=function(){return!0},Transport.prototype.connect=function(){var t=this.server;""!==this.port&&(t+=":"+this.port),this.ws=new WebSocket(this.protocol+"://"+t+"/ws","sip"),console.log("[CONNECT]"),this.ws.onopen=function(){console.log("[OPENED]")},this.ws.onclose=function(){console.log("[CLOSED]")};var e=this.app.stack;this.ws.onmessage=function(t){e.onData(t.data,Reticulum.Parser.parseAddress(t.origin).uri.host)},this.ws.onerror=function(t){console.log("/\\/\\/\\/\\/\\/\\/\\/\\/\\"),console.log(t),console.log("\\/\\/\\/\\/\\/\\/\\/\\/\\/")}},Transport.prototype.listen=function(t){this.ws.onmessage=t},Transport.prototype.send=function(t){try{this.ws.send(t)}catch(e){}},Transport.prototype.disconnect=function(){console.log("[DISCONNECT]"),this.ws.close()},Reticulum.SIP={},Reticulum.SIP.Header=function(){this.name="",this.id=Reticulum.Parser.Enum.SIP_HDR_NONE,this.value=null},Reticulum.SIP.Host=function(){this.name="",this.port="",this.isipv6=!1},Reticulum.SIP.Host.prototype.toString=function(){var t=this.name;return this.isipv6&&(t="["+t+"]"),""!==this.port&&(t+=":"+this.port),t},Reticulum.SIP.URI=function(){this.raw="",this.secure=!1,this.scheme="",this.user="",this.password="",this.hostPort="",this._params_string="",this.params={},this.headers="",this.host=null},Reticulum.SIP.URI.prototype.toString=function(){var t="",e="",s="";return t=Reticulum.Parser.stringifyParams(this.params),""!==this.headers&&(e="?"+this.headers),""!==this.user&&(s=this.user),""!==this.password&&(s+=":"+this.password),""!==s&&(s+="@"),this.scheme+":"+s+this.host.toString()+t+e},Reticulum.SIP.Address=function(){this.value="",this.dname="",this.auri="",this.params={},this._params_string="",this.uri=null},Reticulum.SIP.Address.prototype.toString=function(){var t="";t=Reticulum.Parser.stringifyParams(this.params);var e=this.dname;return-1!==this.dname.indexOf(" ")&&(e='"'+this.dname+'"'),e+"<"+this.uri.toString()+">"+t},Reticulum.SIP.Contact=function(){this.expires="",this.address=null},Reticulum.SIP.Contact.prototype.toString=function(){return this.address.toString()},Reticulum.SIP.Via=function(){this.value="",this.transport="",this.sentby="",this._params_string="",this.params={},this.branch="",this.port=0,this.host=null},Reticulum.SIP.Via.prototype.toString=function(){var t="";return t=Reticulum.Parser.stringifyParams(this.params),"SIP/2.0/"+this.transport+" "+this.host.toString()+t},Reticulum.SIP.CSeq=function(){this.method="",this.number=0},Reticulum.SIP.CSeq.prototype.toString=function(){return this.number+" "+this.method},Reticulum.SIP.ContentType=function(){this.type="",this.subtype="",this._params_string="",this.params={}},Reticulum.SIP.ContentType.prototype.toString=function(){var t="";return t=Reticulum.Parser.stringifyParams(this.params),this.type+"/"+this.subtype+t},Reticulum.SIP.Message=function(){this.headers={},this.vias=[],this.to={},this.from={},this.callid=null,this.cseq=null,this.maxForwards=0,this.contentType=null,this.contentLength=null,this.expires=null,this.contacts=[],this.routes=[],this.record_routes=[],this.responses=[],this.pos=0},Reticulum.SIP.Message.prototype.is1xx=function(){return this.isRequest?!1:this.statusCode>=100&&this.statusCode<200},Reticulum.SIP.Message.prototype.is2xx=function(){return this.isRequest?!1:this.statusCode>=200&&this.statusCode<300},Reticulum.SIP.Message.prototype.isFinal=function(){return this.isRequest?!1:this.statusCode>=200},Reticulum.SIP.Message.prototype.id=function(){return[this.callid,this.method,this.cseq.number].join("|")},Reticulum.SIP.Message.prototype.addHeader=function(t,e,s){var i=new Reticulum.SIP.Header;switch(i.name=t,i.id=e,i.value=s,e){case Reticulum.Parser.Enum.SIP_HDR_VIA:for(var r=i.value.split(","),a=0;a<r.length;a++){var n=Reticulum.Parser.parseVia(r[a]);this.vias instanceof Array?this.vias.push(n):this.vias=[n]}break;case Reticulum.Parser.Enum.SIP_HDR_CONTACT:for(var o=i.value.split(","),u=0;u<o.length;u++){var c=Reticulum.Parser.parseContact(o[u]);this.contacts instanceof Array?this.contacts.push(c):this.contacts=[c]}break;case Reticulum.Parser.Enum.SIP_HDR_RECORD_ROUTE:for(var h=i.value.split(","),l=0;l<h.length;l++){var R=Reticulum.Parser.parseAddress(h[l]);this.record_routes instanceof Array?this.record_routes.push(R):this.record_routes=[R]}break;case Reticulum.Parser.Enum.SIP_HDR_ROUTE:for(var I=i.value.split(","),S=0;S<I.length;S++){var E=Reticulum.Parser.parseAddress(I[S]);this.routes instanceof Array?this.routes.push(E):this.routes=[E]}break;case Reticulum.Parser.Enum.SIP_HDR_TO:this.to=Reticulum.Parser.parseAddress(i.value);break;case Reticulum.Parser.Enum.SIP_HDR_FROM:this.from=Reticulum.Parser.parseAddress(i.value);break;case Reticulum.Parser.Enum.SIP_HDR_CALL_ID:this.callid=i.value;break;case Reticulum.Parser.Enum.SIP_HDR_CSEQ:this.cseq=Reticulum.Parser.parseCSeq(i.value),this.isRequest||(this.method=this.cseq.method);break;case Reticulum.Parser.Enum.SIP_HDR_MAX_FORWARDS:this.maxForwards=i.value;break;case Reticulum.Parser.Enum.SIP_HDR_CONTENT_TYPE:this.contentType=Reticulum.Parser.parseContentType(i.value);break;case Reticulum.Parser.Enum.SIP_HDR_CONTENT_LENGTH:this.contentLength=i.value;break;case Reticulum.Parser.Enum.SIP_HDR_EXPIRES:this.expires=i.value;break;case Reticulum.Parser.Enum.SIP_HDR_WWW_AUTHENTICATE:case Reticulum.Parser.Enum.SIP_HDR_PROXY_AUTHENTICATE:this.challenge=Reticulum.Parser.parseAuthenticate(i.value),this.challenge.proxy=e===Reticulum.Parser.Enum.SIP_HDR_PROXY_AUTHENTICATE,this.headers[e]=i;break;case Reticulum.Parser.Enum.SIP_HDR_AUTHORIZATION:case Reticulum.Parser.Enum.SIP_HDR_PROXY_AUTHORIZATION:this.auth=Reticulum.Parser.parseAuthorization(i.value),this.auth.proxy=e===Reticulum.Parser.Enum.SIP_HDR_PROXY_AUTHORIZATION,this.headers[e]=i;break;default:if(Reticulum.Parser.isCommaSeparatedHeader(e))for(var m=i.value.split(","),_=0;_<m.length;_++)this.headers[e]instanceof Array?this.headers[e].push({value:m[_],name:i.name,id:i.id}):this.headers[e]=[{value:m[_],name:i.name,id:i.id}];else this.headers[e]=i}},Reticulum.SIP.Message.prototype.copyVias=function(t){for(var e=0;e<t.length;e++)this.addHeader("Via",Reticulum.Parser.Enum.SIP_HDR_VIA,t[e].value)},Reticulum.SIP.Message.prototype.getBody=function(){return this.body?this.body:this.raw?this.raw.substr(this.pos):""},Reticulum.SIP.Message.prototype.toString=function(){var t="";if(this.isRequest){var e=this.remoteURI;EXISTS(e)||(e=this.uri.toString()),EXISTS(this.uri.scheme)||(e="sips:"+e),t+=this.method+" "+e+" "+this.version+"\r\n"}else t+=this.version+" "+this.statusCode+" "+this.reason+"\r\n";var s=null,i=Object.keys(this.headers),r={};for(u=0;u<this.vias.length;u++)r=this.vias[u],t+="Via: "+r.toString()+"\r\n";t+="To: "+this.to.toString()+"\r\n",t+="From: "+this.from.toString()+"\r\n",t+="Call-ID: "+this.callid+"\r\n",t+="CSeq: "+this.cseq.toString()+"\r\n";var a={};for(u=0;u<this.contacts.length;u++)a=this.contacts[u],t+="Contact: "+a.toString()+"\r\n";var n={};for(u=0;u<this.routes.length;u++)n=this.routes[u],t+="Route: "+n.toString()+"\r\n";var o={};for(u=0;u<this.record_routes.length;u++)o=this.record_routes[u],t+="Record-Route: "+o.toString()+"\r\n";console.log("TO_S",this.contentType,this.contentLength,this.content),EXISTS(this.maxForwards)&&(t+="Max-Forwards: "+this.maxForwards+"\r\n"),EXISTS(this.contentType)&&(t+="Content-Type: "+this.contentType.toString()+"\r\n"),EXISTS(this.contentLength)&&(t+="Content-Length: "+this.contentLength+"\r\n"),EXISTS(this.expires)&&(t+="Expires: "+this.expires+"\r\n");var u=0;for(u=0;u<i.length;u++)s=this.headers[i[u]],t+=s.name+": "+s.value,t+="\r\n";return t+="\r\n",t+=this.getBody()};var sip=Reticulum.SIP,AuthInfo=function(t,e,s){this.user=t,this.password=e,this.realm=s||"reticulum",this.nc=0},Phone=function(t,e,s,i,r,a){var n=this;this.transport=new Transport(n,i,r,a),this.stack=new Stack(n,this.transport),this.media=new Media(!0,!0),this._ua=new UA(n,this.stack,this.media,s,i),this.media.setVideoContainersIDs("localVideo","remoteVideo"),this.media.getMedia(),this.refreshRegistration=null,this.regState="UNREGISTERED",this._ua.setState("IDLE"),this.media.handleOffer=function(t,e,s){n._ua.sendInvite(t,e,s)},this.media.handleAnswer=function(){n._ua.uacore.sendResponse(n._ua.uacore.createResponse(200,"OK",n.media.getLocalSDP(),"application/sdp"))},this.autorespond=t,this.autodecline=e,this.authinfo=s,this.user=s.user,this.realm=i,this.server=i+":"+r};Phone.prototype.setStateFromTransaction=function(t,e,s,i,r){"INV_SERVER"===t&&"PROCEEDING"===e&&"COMPLETED"===s?this._ua.setState("ACTIVE"):"INV_SERVER"===t&&"COMPLETED"===e&&"CONFIRMED"===s&&"INVITE"===i?this._ua.setState("IDLE"):"INV_CLIENT"===t&&"COMPLETED"===e&&"TERMINATED"===s&&"INVITE"===i?this._ua.setState("IDLE"):"TERMINATING"===this.state&&"NON_CLIENT"===t&&"BYE"===i&&"TRYING"===e&&"COMPLETED"===s&&this._ua.setState("IDLE")},Phone.prototype._setState=function(t){if(UI.disable("reg"),UI.disable("connect"),UI.disable("call"),UI.disable("answer"),UI.disable("reject"),UI.disable("hangup"),"IDLE"===t)UI.setLabel("AVAILABLE"),UI.enable("call");else if("PROCEEDING"===t)UI.setLabel("RINGING"),UI.enable("answer"),UI.enable("reject");else if("PREPARING"===t)UI.setLabel("PREPARING CALL");else if("INVITING"===t)UI.setLabel("CALLING"),UI.enable("reject");else if("ACTIVE"===t)UI.setLabel("ON CALL"),UI.enable("hangup");else if("ACCEPTED"===t)UI.setLabel("ON CALL"),UI.enable("hangup");else if("CONFIRMED"===t);else if("COMPLETED"===t);else if("TERMINATING"===t){if("ACTIVE"==this.state)return void this._ua.setState("IDLE")}else"TERMINATED"===t||(UI.setLabel("UNAVAILABLE"),UI.disable("reg"),UI.enable("connect"));"REGISTERED"===this.regState||"REGISTERING"===this.regState||"UNREGISTERING"===this.regState||"UNREGISTERED"===this.regState&&(UI.enable("reg"),UI.disable("connect"),UI.disable("call"),UI.disable("answer"),UI.disable("reject"),UI.disable("hangup"),UI.setLabel("UNREGISTERED")),this.state=t},Phone.prototype._setRegState=function(t){this.regState=t},Phone.prototype.close=function(){},Phone.prototype.onRequest=function(t,e,s){"MESSAGE"===e.method?this.onMessage(t,e):"INVITE"===e.method||"BYE"===e.method||"ACK"===e.method?this.onInvite(t,e):t.sendResponse(501,"Method Not Implemented")},Phone.prototype.onResponse=function(t,e,s){this._ua.onResponse(t,e)},Phone.prototype.onMessage=function(t,e){this.auto_respond?t.sendResponse(t.createResponse(200,"OK")):this.autodecline&&t.sendResponse(t.createResponse(603,"Decline"))},Phone.prototype.onInvite=function(t,e){if(this.autodecline)return void t.sendResponse(t.createResponse(603,"Decline"));if("INVITE"===e.method)if("IDLE"===this.state){if(EXISTS(this._ua)||(this._ua.app=this,this._ua.uacore=t,this._ua.uacore.app=this),this._ua.setState("INVITED"),e.getBody()&&EXISTS(e.contentType)&&"sdp"===e.contentType.subtype?(req=e,this.media?this.media.setRemoteSDP(e.getBody()):console.log("Missing media while processing received INVITE")):console.log("No SDP in received INVITE"),null===this.media.getLocalSDP()&&(this._ua.setState("IDLE"),t.sendResponse(t.createResponse(488,"Incompatible SDP"))),this._ua.setState("PROCEEDING"),t.sendResponse(t.transaction.createResponse(180,"Ringing")),this._ua.uacore=t,this.autorespond&&(this.media.makeAnswer(),this.autohangup)){var s=this;console.log("*** on auto answer hangup in 10s ***"),"undefined"!=typeof window&&window?window.setTimeout(function(){s._ua.closeCall()},1e4):setTimeout(function(){s._ua.closeCall()},1e4)}}else t.sendResponse(t.createResponse(486,"Busy Here"));else if("BYE"===e.method)this._ua.uacore===t?(this.media.stopAudio(),"IDLE"!==this.state&&(this._ua.setState("IDLE"),t.sendResponse(t.createResponse(200,"OK"))),this._ua.closeCore()):t.sendResponse(t.createResponse(481,"Dialog Not Found"));else if("ACK"===e.method)if(this._ua.uacore===t)if("ACCEPTED"===this.state){if(this._ua.setState("ACTIVE"),e.getBody()&&EXISTS(e.contentType)&&"sdp"===e.contentType.subtype){var i=e.getBody();this.media?this.media.setRemoteSDP(i):console.log("Missing media while processing received ACK")}else console.log("no SDP in received ACK");!this.options.audio_loopback&&this.options.audio&&this.media.startAudio()}else console.log("Ignoring ACK for UA state:",this.state);else console.log("Received ACK for invalid UA.")},Phone.prototype.onCancelled=function(t,e,s){},Phone.prototype.dialogCreated=function(t,e,s,i){this._ua.dialogCreated(t,e)},Phone.prototype.createServer=function(t,e,s){return"CANCEL"!==t.method?new UACore(s,t,this.authinfo):null},Phone.prototype.send=function(t,e,s){this.transport.send(t,e)},Phone.prototype.register=function(){this._ua.register()},Phone.prototype.call=function(t,e){this._setState("PREPARING"),this.media.makeOffer(t,e)},Phone.prototype.answer=function(){this.media.makeAnswer()},Phone.prototype.reject=function(){this._ua.closeCall()};var UA=function(t,e,s,i,r){this.app=t,this.state=t.state,this.stack=e,this.uacore=null,this.scheme=this.stack.transport.secure?"sips":"sip",this.user=i.user,this.domain=r,this.local=Reticulum.Parser.parseAddress(this.scheme+":"+this.user+"@"+r),this.regInterval=3600,this.createClient(this.local,this.local,r,i),this.media=s,this.authinfo=i};UA.prototype.setState=function(t){this.state=t,this.app._setState(t)},UA.prototype.setRegState=function(t){this.app._setRegState(t)},UA.prototype.onClose=function(){},UA.prototype.register=function(){this.setState("REGISTERING"),this.uacore.sendRequest(this.createRequest("REGISTER"))},UA.prototype.createClient=function(t,e,s,i){this.uacore=new UACore(this.stack,null,i),this.uacore.local=t,this.uacore.remote=e,this.uacore.remoteTarget=s},UA.prototype.refreshLater=function(t,e){var s=3600;EXISTS(t)&&(s=t);var i=this;"undefined"!=typeof window&&window?window.setTimeout(function(){e.call(i)},1e3*s):setTimeout(function(){e.call(i)},1e3*s)},UA.prototype.retryLater=function(t){var e=7200,s=this;"undefined"!=typeof window&&window?window.setTimeout(function(){t.call(s)},1e3*e):setTimeout(function(){t.call(s)},1e3*e)},UA.prototype.sendLater=function(t,e){},UA.prototype.dialogCreated=function(t,e){this._oldcore=this.uacore,this.uacore=t,this.uacore.app=this},UA.prototype.sendInvite=function(t,e,s){this.remote=Reticulum.Parser.parseAddress(t),this.remoteTarget=this.remote.uri,this.uacore.remote=this.remote,this.uacore.remoteTarget=this.remoteTarget,this.uacore.localTag=Utils.token(10,Utils.TOKEN_NUMERIC_32),this.uacore.callid=this.stack.createCallID(),this.setState("INVITING");var i=this.createRequest("INVITE",s,this.media.getLocalSDP());this.uacore.sendRequest(i)},UA.prototype.sendAnswer=function(){this.ua.sendResponse(this.ua.createResponse(200,"OK",this.media.getLocalSDP(),"application/sdp"))},UA.prototype.createRequest=function(t,e,s){var i=null,r=3600,a=0;return EXISTS(s)&&(a=s.length),"REGISTER"===t?(i=this.uacore.createRegister(this.scheme+":"+this.user+"@"+this.domain),i.addHeader("Expires",Reticulum.Parser.Enum.SIP_HDR_EXPIRES,r)):"MESSAGE"===t?(i=this.uacore.createRequest(t),i.addHeader("User-Agent",Reticulum.Parser.Enum.SIP_HDR_USER_AGENT,"Reticulum client 0.0.1 Chrome"),EXISTS(e)&&i.addHeader("Subject",Reticulum.Parser.Enum.SIP_HDR_SUBJECT,e),i.addHeader("Content-Type",Reticulum.Parser.Enum.SIP_HDR_CONTENT_TYPE,"text/plain"),i.addHeader("Content-Length",Reticulum.Parser.Enum.SIP_HDR_CONTENT_LENGTH,a),i.body=s):"INVITE"===t?(i=this.uacore.createRequest(t),i.addHeader("User-Agent",Reticulum.Parser.Enum.SIP_HDR_USER_AGENT,"Reticulum client 0.0.1 Chrome"),EXISTS(e)&&i.addHeader("Subject",Reticulum.Parser.Enum.SIP_HDR_SUBJECT,e),i.addHeader("Content-Type",Reticulum.Parser.Enum.SIP_HDR_CONTENT_TYPE,"application/sdp"),i.addHeader("Content-Length",Reticulum.Parser.Enum.SIP_HDR_CONTENT_LENGTH,a),i.body=s):"BYE"===t&&(i=this.uacore.createRequest(t),i.addHeader("User-Agent",Reticulum.Parser.Enum.SIP_HDR_USER_AGENT,"Reticulum client 0.0.1 Chrome")),i},UA.prototype.onResponse=function(t,e){if("REGISTER"===e.method)"REGISTERING"===this.state?e.is2xx()?(this.stack.fixedContact=e.contacts[0],this.stack.fixedVia=e.vias[0],this.setRegState("REGISTERED"),this.setState("IDLE"),this.refreshLater(e.expires,this.register)):e.isFinal()&&(this.setRegState("UNREGISTERED"),this.setState("IDLE")):"UNREGISTERING"===this.state&&e.isFinal()&&(this.setState("IDLE"),"REGISTERING"!==this.state&&"REGISTERED"!==this.state||(this.setRegState("UNREGISTERED"),this.setState("UNREGISTERING"),this.register(!1)),this.setState("IDLE"));else if("INVITE"===e.method){var s=null;"INVITING"===this.state?e.is2xx()?(this.setState("ACTIVE"),e.getBody()?this.media?(this.media.setRemoteSDP(e.getBody()),t.sendRequest(this.uacore.createAck(e))):console.log("Error. Missing media while processing 200 OK"):console.log("Error. No SDP in received 200 OK")):183===e.statusCode?e.getBody()&&EXISTS(e.contentType)&&"sdp"===e.contentType.subtype&&(s=e.getBody(),this.media?this.media.setRemoteSDP(s):console.log("Error. Invalid media received in 200 OK")):e.isFinal()&&(this.closeCore(),this.setState("IDLE")):"TERMINATING"===this.state&&e.isFinal()}},UA.prototype.closeCore=function(){EXISTS(this.uacore.close)&&(this.uacore.close(),this.uacore=null,this.uacore=this._oldcore)},UA.prototype.onRequest=function(t,e){var s=null;"INVITE"===e.method?"IDLE"===this.state?(this.uacore=t,this.uacore.app=this,this.setState("INVITED"),null===this.media.localSDP?(this.setState("IDLE"),t.sendResponse(t.createResponse(488,"Incompatible SDP"))):this.autorespond):t.sendResponse(t.createResponse(486,"Busy Here")):"BYE"===e.method?this.uacore===t?(this.media.stopAudio(),this.closeCore(),"IDLE"!==this.state&&(this.setState("IDLE"),t.sendResponse(t.createResponse(200,"OK")))):t.sendResponse(t.createResponse(481,"Dialog Not Found")):"ACK"===e.method&&(this.uacore===t?"ACCEPTED"===this.state?(this.setState("ACTIVE"),e.getBody()&&e["Content-Type"]&&"application/sdp"===e["Content-Type"].value.lower()?(s=e.getBody(),this.media?this.media.setRemote(s):console.log("invalid media in processing received ACK")):console.log("no SDP in received ACK"),this.media.audio):console.log("ignoring ACK in state",this.state):console.log("received ACK for invalid UA"))},UA.prototype.closeCall=function(){"ACTIVE"===this.state||"INVITING"===this.state||"ACCEPTED"===this.state?("INVITING"===this.state?(this.setState("TERMINATING"),this.uacore.sendCancel()):(this.setState("TERMINATING"),this.uacore.sendRequest(this.uacore.createRequest("BYE"))),this.media.stopAudio()):"INVITED"===this.state?this.uacore.sendResponse(this.uacore.createResponse(480,"Temporarily Unavailable")):"PROCEEDING"===this.state&&this.uacore.sendResponse(this.uacore.createResponse(603,"Decline"))};var EXISTS=function(t){return void 0===t?!1:null!==t},Message={};Message.createRequest=function(t,e){var s=new Reticulum.SIP.Message;return s.isRequest=!0,s.method=t,s.uri=e,s.version="SIP/2.0",s},Message.createResponse=function(t,e,s,i,r){var a=new Reticulum.SIP.Message;return a.isRequest=!1,a.statusCode=t,a.reason=e,a.version="SIP/2.0",EXISTS(r)&&(a.to=r.to,a.addHeader("To",Reticulum.Parser.Enum.SIP_HDR_TO,r.to.toString()),a.addHeader("From",Reticulum.Parser.Enum.SIP_HDR_FROM,r.from.toString()),a.addHeader("CSeq",Reticulum.Parser.Enum.SIP_HDR_CSEQ,r.cseq.toString()),a.addHeader("Call-ID",Reticulum.Parser.Enum.SIP_HDR_CALL_ID,r.callid),a.copyVias(r.vias),100===t&&(a.timestamp=r.timestamp)),EXISTS(s)&&console.log("ADD HEADERS"),EXISTS(i)&&(a.body=i),a};var Stack=function(t,e){this.tag=Utils.uuid(),this.app=t,this.transport=e,this.closing=!1,this.dialogs=new HashTable,this.transactions=new HashTable,this.requests=new HashTable,this.fixedContact=null,this.fixedVia=null,this.stores={transactions:new HashTable,requests:new HashTable}};Stack.prototype["delete"]=function(){this.closing=!0,this.dialogs.clear(),this.transactions.clear()},Stack.prototype.uri=function(){var t=this.transport.isSecure()?"sips":"sip";return t="sip",t+=":"+this.transport.server+":"+this.transport.port},Stack.prototype.createCallID=function(){var t=this.transport.host;return EXISTS(t)||(t="localhost"),Utils.uuid()+"@"+t},Stack.prototype.createVia=function(t){return EXISTS(this.transport)?t&&!this.trasport.isSecure()?(console.log("No secure transport in stack"),null):Reticulum.Parser.parseVia("SIP/2.0/"+this.transport.protocol.toUpperCase()+" r3t1cu1um.invalid;rport"):(console.log("No transport in stack"),null)},Stack.prototype.send=function(t,e){t.isRequest||EXISTS(e)||EXISTS(t.vias)&&EXISTS(t.vias[0].sentby)&&(e=t.vias[0].sentby);var s=Date.now();t.direction="out",t.transportDestination=e,t.sentAt=s;var i={id:t.id(),request:t.isRequest,direction:"out",source:null,destination:e,parseTime:null,receivedAt:null,sentAt:s,raw:t.toString(),method:t.method,code:t.isRequest?0:t.statusCode,responses:[]};t.isRequest?(console.log("Archive req on send"),EXISTS(this.requests.getItem(t.id()))&&console.log("Warning request already archived"),this.requests.setItem(t.id(),t),this.stores.requests.setItem(t.id(),i)):(console.log("Archive resp on send"),EXISTS(this.requests.getItem(t.id()))?(this.requests.getItem(t.id()).responses.push(t),this.stores.requests.getItem(t.id()).responses.push(i)):console.log("Corresponding request for this response was not found")),this.app.send(t.toString(),e)},Stack.prototype.onData=function(t,e){var s=Date.now(),i=Reticulum.Parser.parse(t);if(!EXISTS(i))throw console.log("Error. Received invalid message."),"Received invalid message";var r=Date.now();i.direction="in",i.transportSource=e,i.parseTime=r-s,i.receivedAt=s;var a={id:i.id(),request:i.isRequest,direction:"in",source:e,destination:null,parseTime:r-s,receivedAt:s,sentAt:null,raw:i.toString(),method:i.method,code:i.isRequest?0:i.statusCode,responses:[]};if(i.isRequest?(EXISTS(this.requests.getItem(i.id()))&&console.log("Warning request already archived"),this.requests.setItem(i.id(),i),this.stores.requests.setItem(i.id(),a)):EXISTS(this.requests.getItem(i.id()))?(console.log(i.id(),this.requests.getItem(i.id()).responses),this.requests.getItem(i.id()).responses.push(i),this.stores.requests.getItem(i.id()).responses.push(a)):console.log("Corresponding request for this response was not found"),i.isRequest){if(!EXISTS(i.vias)||0===i.vias.length)throw console.log("Error. No via header in request."),"No via header in request";i.vias[0].host.name===e.name&&i.vias[0].port===e.port||(i.vias[0].received=e.name,i.vias[0].host.name=e.name),EXISTS(i.vias[0].rport)&&(messsage.vias[0].rport=e.port,i.vias[0].uri.port=e.port),"tcp"===this.transport.type&&(i.vias[0].rport=e.port,i.vias[0].port=e.port),this.handleRequest(i)}else this.handleResponse(i)},Stack.prototype.handleRequest=function(t,e){var s=null,i=null,r=null,a=null,n=t.vias[0].params.branch;if("ACK"===t.method?(s=this.findTransaction(n),(null===s||null!==s.lastResponse&&s.lastResponse.is2xx())&&(s=this.findTransaction(Transaction.createId(n,t.method)))):s=this.findTransaction(Transaction.createId(n,t.method)),EXISTS(s))s.isServer?s.onRequest(t):this.send(Message.createResponse(482,"Loop detected",null,null,t));else{if("CANCEL"!==t.method&&EXISTS(t.to.params.tag)){if(i=this.findDialog(t),EXISTS(i))r=i;else if("ACK"!==t.method){if(a=this.createServer(t,e),!EXISTS(a))return void this.send(Message.createResponse(481,"Dialog does not exist",null,null,t));r=a}else if("0"!==n){if(s=this.findTransaction(Transaction.createId(n,"INVITE")),EXISTS(s)&&"TERMINATED"!==s.state)return void s.onRequest(t);if(a=this.createServer(t,e),!EXISTS(a))return void console.log("Error no UAS component created!");r=a}}else if("CANCEL"!==t.method)if(a=this.createServer(t,e),EXISTS(a))r=a;else{if("OPTIONS"===t.method){var o=Message.createResponse(200,"OK",null,null,t);return o.addHeader("Allow",Reticulum.Parser.Enum.SIP_HDR_ALLOW,"INVITE, ACK, CANCEL, BYE, OPTIONS"),void this.send(o)}if("ACK"!==t.method)return void this.send(Message.createResponse(405,"Method not allowed",null,null,t))}else{if(s=this.findTransaction(Transaction.createId(n,"INVITE")),!EXISTS(s))return void this.send(Message.createResponse(481,"Original transaction does not exist",null,null,t));r=s.app}EXISTS(r)?(s=r.createTransaction(t),"ACK"===t.method&&null!==s&&void 0!==this.transactions.getItem(s.id)&&this.transactions.removeItem(s.id)):"ACK"!==t.method&&(console.log("Error 404 not found!"),this.send(Message.createResponse(404,"Not found",null,null,t)))}},Stack.prototype.handleResponse=function(t){var e=t.vias[0].params.branch,s=this.findTransaction(Transaction.createId(e,t.method)),i=null;if(null===s){if("INVITE"===t.method&&t.is2xx())i=this.findDialog(t),null===i?console.log("Error, no dialog found for response",t.statusCode,"to",t.method):(i.onResponse(null,t),this.app._ua.closeCore());else if("INVITE"===t.method&&t.isFinal()){var r=Message.createRequest("ACK",t.to.uri);r.addHeader("To",Reticulum.Parser.Enum.SIP_HDR_TO,t.to.value),r.addHeader("From",Reticulum.Parser.Enum.SIP_HDR_FROM,t.from.value),r.addHeader("Call-ID",Reticulum.Parser.Enum.SIP_HDR_CALL_ID,t.callid),r.addHeader("CSeq",Reticulum.Parser.Enum.SIP_HDR_CSEQ,t.cseq.number+" ACK"),r.copyVias(t.vias),this.send(r),this.app._ua.closeCore(),this.app._ua.setState("IDLE")}}else s.onResponse(t),"BYE"===t.method&&t.is2xx()?this.app._ua.closeCore():"BYE"===t.method&&t.isFinal()&&this.app._ua.closeCore()},Stack.prototype.createServer=function(t,e){return this.app.createServer(t,e,this)},Stack.prototype.sending=function(t,e){return EXISTS(this.app)&&EXISTS(this.app.sending)?this.app.sending(t,e,this):null},Stack.prototype.onRequest=function(t,e){this.app.onRequest(t,e,this)},Stack.prototype.onResponse=function(t,e){this.app.onResponse(t,e,this)},Stack.prototype.cancelled=function(t,e){},Stack.prototype.dialogCreated=function(t,e){this.app.dialogCreated(t,e,this)},Stack.prototype.authenticate=function(t,e){return EXISTS(this.app)&&EXISTS(this.app.authenticate)?this.app.authenticate(t,e,this):!1},Stack.prototype.createTimer=function(t,e){return new Timer(t,e)},Stack.prototype.findDialog=function(t){var e=this.dialogs.getItem(Dialog.extractId(t));return e?e.closed?null:e:null},Stack.prototype.findTransaction=function(t){var e=this.transactions.getItem(t);return EXISTS(e)?("TERMINATED"===e.state&&console.log("Found Terminated transaction with id:",t),e):null};var Transaction=function(t){this.branch=null,this.id=null,this.stack=null,this.app=null,this.request=null,this.transport=null,this.remote=null,this.tag=null,this.history=[],this.isServer=t,this.timers=new HashTable,this.timerconfs=new TimerConfs,this.type=t?"UNK_SERVER":"UNK_CLIENT"};Transaction.prototype.close=function(){this.stopTimers(),EXISTS(this.stack)&&EXISTS(this.stack.transactions.getItem(this.id))&&this.stack.transactions.removeItem(this.id)},Transaction.prototype.setState=function(t){var e="UNKNOWN",s=null,i=this.branch+"|"+this.request.method;EXISTS(this.request)&&(e=this.request.method,s=this.stack.stores.requests.getItem(this.request.id())),this.history.push({from:this.state,to:t,at:Date.now()});var r={id:i,state:t,type:this.type,history:this.history,request:s};this.stack.app.setStateFromTransaction(this.type,this.state,t,e,{id:i,data:r}),this.state=t,"TERMINATED"===t&&this.stack.stores.transactions.setItem(this.branch+"|"+e,r)},Transaction.prototype.getState=function(){return this.state},Transaction.createBranch=function(t){var e="z9hG4bK";return e+=Utils.token(8,Utils.TOKEN_NUMERIC_16)},Transaction.createId=function(t,e){return"ACK"!==e&&"CANCEL"!==e?t:t+"|"+e},Transaction.createServer=function(t,e,s,i,r,a){var n=null;return n="INVITE"===s.method?new InviteServerTransaction:new ServerTransaction,n.isServer=!0,n.stack=t,n.app=e,n.request=s,n.transport=i,n.tag=r,EXISTS(s.vias)&&EXISTS(s.vias[0].sentby)&&(n.remote=s.vias[0].sentby),EXISTS(s.vias)&&EXISTS(s.vias[0].params.branch)?n.branch=s.vias[0].params.branch:n.branch=Transaction.createBranch(s),n.id=Transaction.createId(n.branch,s.method),t.transactions.setItem(n.id,n),a===!0?n.start():n.setState("TRYING"),n},Transaction.createClient=function(t,e,s,i,r){var a=null;return a="INVITE"===s.method?new InviteClientTransaction:new ClientTransaction,a.isServer=!1,a.stack=t,a.app=e,a.request=s,a.transport=i,a.remote=r,EXISTS(s.vias)&&EXISTS(s.vias[0].params.branch)?a.branch=s.vias[0].params.branch:a.branch=Transaction.createBranch(s),a.id=Transaction.createId(a.branch,s.method),t.transactions.setItem(a.id,a),a.start(),a},Transaction.prototype.createAck=function(){var t=null;return EXISTS(this.request)&&!this.isServer&&(t=Message.createRequest("ACK",this.request.uri),t.addHeader("Call-ID",Reticulum.Parser.Enum.SIP_HDR_CALL_ID,this.request.callid),t.addHeader("From",Reticulum.Parser.Enum.SIP_HDR_FROM,this.request.from.toString()),t.addHeader("To",Reticulum.Parser.Enum.SIP_HDR_TO,this.request.to.toString()),t.addHeader("CSeq",Reticulum.Parser.Enum.SIP_HDR_CSEQ,this.request.cseq.number+" ACK"),t.copyVias(this.request.vias)),t},Transaction.prototype.createCancel=function(){var t=null;return EXISTS(this.request)&&!this.isServer&&(t=Message.createRequest("CANCEL",this.request.uri),t.addHeader("Call-ID",Reticulum.Parser.Enum.SIP_HDR_CALL_ID,this.request.callid),t.addHeader("From",Reticulum.Parser.Enum.SIP_HDR_FROM,this.request.from.toString()),t.addHeader("To",Reticulum.Parser.Enum.SIP_HDR_TO,this.request.to.toString()),t.addHeader("CSeq",Reticulum.Parser.Enum.SIP_HDR_CSEQ,this.request.cseq.number+" CANCEL"),t.copyVias(this.request.vias)),EXISTS(this.request.routes)&&(t.routes=this.request.routes),t},Transaction.prototype.createResponse=function(t,e){var s=null;return EXISTS(this.request)&&this.isServer&&(s=Message.createResponse(t,e,null,null,this.request)),100===t||EXISTS(s.to.params.tag)||(s.to.params.tag=this.tag),s},Transaction.prototype.startTimer=function(t,e){if(!(0>=e)){var s=this.timers.getItem(t);EXISTS(s)||(s=this.stack.createTimer(t,this),this.timers.setItem(t,s)),s.start(e)}},Transaction.prototype.stopTimers=function(){this.timers.each(function(t,e){e.stop()}),this.timers.clear()},Transaction.prototype.timedout=function(t){var e=this.timers.getItem(t);EXISTS(e)&&(e.isRunning()&&e.stop(),this.timeout(t,e.delay),this.timers.removeItem(t))};var TimerConfs=function(t,e,s){this.t1=t,this.t2=e,this.t4=s,EXISTS(t)||(this.t1=500),EXISTS(e)||(this.t2=4e3),EXISTS(s)||(this.t4=5e3),this.A=this.t1,this.B=64*this.t1,this.D=Math.max(64*this.t1,32e3),this.E=this.A,this.F=this.B,this.G=this.A,this.H=this.B,this.I=this.t4,this.J=this.B,this.K=this.I},Timer=function(t,e){this.name=t,this.ticker=null;var s=this;this.callback=function(){e.timedout(s.name),s.ticker=null}};Timer.prototype.start=function(t){this.delay=t,this.ticker=null,"undefined"!=typeof window&&window?this.ticker=window.setTimeout(this.callback,t):this.ticker=setTimeout(this.callback,t)},Timer.prototype.stop=function(){"undefined"!=typeof window&&window?window.clearTimeout(this.ticker):clearTimeout(this.ticker),this.ticker=null},Timer.prototype.isRunning=function(){return null!==this.ticker};var ClientTransaction=function(){Transaction.call(this,!1)};ClientTransaction.prototype=Object.create(Transaction.prototype),ClientTransaction.prototype.constructor=ClientTransaction,ClientTransaction.prototype.start=function(){this.setState("TRYING"),this.type="NON_CLIENT",this.transport.isReliable()||this.startTimer("E",this.timerconfs.E),this.startTimer("F",this.timerconfs.F),this.stack.send(this.request,this.remote,this.transport)},ClientTransaction.prototype.onResponse=function(t){t.is1xx()?"TRYING"===this.state?(this.setState("PROCEEDING"),this.app.onResponse(this,t)):"PROCEEDING"===this.state&&this.app.onResponse(this,t):t.isFinal()&&("TRYING"!==this.state&&"PROCEEDING"!==this.state||(this.setState("COMPLETED"),this.app.onResponse(this,t),
this.transport.isReliable()?this.timeout("K",0):this.startTimer("K",this.timerconfs.K)))},ClientTransaction.prototype.timeout=function(t,e){"TRYING"===this.state||"PROCEEDING"===this.state?"E"===t?(e="TRYING"==this.state?Math.min(2*e,this.timerconfs.t2):this.timerconfs.t2,this.startTimer("E",e),this.stack.send(this.request,this.remote,this.transport)):"F"===t&&(this.setState("TERMINATED"),this.app.timeout(this)):"COMPLETED"===this.state&&"K"===t&&this.setState("TERMINATED")},ClientTransaction.prototype.error=function(t){"TRYING"!==this.state&&"PROCEEDING"!==this.state||(this.setState("TERMINATED"),this.app.error(this,t))};var ServerTransaction=function(){Transaction.call(this,!0)};ServerTransaction.prototype=Object.create(Transaction.prototype),ServerTransaction.prototype.constructor=ServerTransaction,ServerTransaction.prototype.start=function(){this.setState("TRYING"),this.type="NON_SERVER",this.app.onRequest(this,this.request)},ServerTransaction.prototype.onRequest=function(t){this.request.method===t.method&&("PROCEEDING"!==this.state&&"COMPLETED"!==this.state||this.stack.send(this.lastResponse,this.remote,this.transport))},ServerTransaction.prototype.timeout=function(t,e){"COMPLETED"===this.state&&"J"===t&&this.setState("TERMINATED")},ServerTransaction.prototype.error=function(t,e){"COMPLETED"===this.state&&(this.setState("TERMINATED"),this.app.error(error))},ServerTransaction.prototype.sendResponse=function(t){this.lastResponse=t,t.is1xx()?"TRYING"!==this.state&&"PROCEEDING"!==this.state||(this.setState("PROCEEDING"),this.stack.send(t,this.remote,this.transport)):t.isFinal()&&("PROCEEDING"!==this.state&&"TRYING"!==this.state||(this.setState("COMPLETED"),this.stack.send(t,this.remote,this.transport),this.transport.isReliable()?this.timeout("J",0):this.startTimer("J",this.timerconfs.J)))};var InviteClientTransaction=function(){Transaction.call(this,!1)};InviteClientTransaction.prototype=Object.create(Transaction.prototype),InviteClientTransaction.prototype.constructor=InviteClientTransaction,InviteClientTransaction.prototype.start=function(){this.setState("CALLING"),this.type="INV_CLIENT",this.transport.isReliable()||this.startTimer("A",this.timerconfs.A),this.startTimer("B",this.timerconfs.B),this.stack.send(this.request,this.remote,this.transport)},InviteClientTransaction.prototype.onResponse=function(t){t.is1xx()?"CALLING"===this.state?(this.setState("PROCEEDING"),this.app.onResponse(this,t)):"PROCEEDING"===this.state&&this.app.onResponse(this,t):t.is2xx()?"CALLING"!==this.state&&"PROCEEDING"!==this.state||(this.setState("TERMINATED"),this.app.onResponse(this,t),this.stack.app._ua.setState("ACCEPTED")):"CALLING"===this.state||"PROCEEDING"===this.state?(this.setState("COMPLETED"),this.stack.send(this.createAck(t),this.remote,this.transport),this.app.onResponse(this,t),this.transport.isReliable()?this.timeout("D",0):this.startTimer("D",this.timerconfs.D)):"COMPLETED"===this.state&&this.stack.send(this.createAck(t),this.remote,this.transport)},InviteClientTransaction.prototype.timeout=function(t,e){"CALLING"===this.state?"A"===t?(this.startTimer("A",2*e),this.stack.send(this.request,this.remote,this.transport)):"B"===t&&(this.setState("TERMINATED"),this.app.timeout(this)):"COMPLETED"===this.state&&"D"===t&&this.setState("TERMINATED")},InviteClientTransaction.prototype.error=function(t){"CALLING"!==this.state&&"COMPLETED"!==this.state||(this.setState("TERMINATED"),this.app.error(this,t))},InviteClientTransaction.prototype.createAck=function(t){var e=null;EXISTS(this.request)||console.log("There is no request in this Transaction");var s=this.request.to;EXISTS(t)&&(s=t.to);var i=this.request.from;return EXISTS(t)&&(i=t.from),e=Message.createRequest("ACK",this.request.uri),e.addHeader("Call-ID",Reticulum.Parser.Enum.SIP_HDR_CALL_ID,this.request.callid),e.addHeader("From",Reticulum.Parser.Enum.SIP_HDR_FROM,i.toString()),e.addHeader("To",Reticulum.Parser.Enum.SIP_HDR_TO,s.toString()),e.addHeader("CSeq",Reticulum.Parser.Enum.SIP_HDR_CSEQ,this.request.cseq.number+" ACK"),e.copyVias(this.request.vias),EXISTS(this.request.routes)&&(e.routes=this.request.routes),e};var InviteServerTransaction=function(){Transaction.call(this,!1)};InviteServerTransaction.prototype=Object.create(Transaction.prototype),InviteServerTransaction.prototype.constructor=InviteServerTransaction,InviteServerTransaction.prototype.start=function(){this.retrans=0,this.setState("PROCEEDING"),this.type="INV_SERVER",this.app.onRequest(this,this.request)},InviteServerTransaction.prototype.onRequest=function(t){this.request.method===t.method?"PROCEEDING"!==this.state&&"COMPLETED"!==this.state||(this.retrans=this.retrans+1,console.log("Retransmittion #"+this.retrans+" INVITE response due to retransmission from remote endpoint"),this.stack.send(this.lastResponse,this.remote,this.transport)):"ACK"===t.method&&"COMPLETED"===this.state&&(this.setState("CONFIRMED"),this.transport.isReliable()?this.timeout("I",0):this.startTimer("I",this.timerconfs.I))},InviteServerTransaction.prototype.timeout=function(t,e){"COMPLETED"===this.state?"G"===t?(this.startTimer("G",Math.min(2*e,this.timerconfs.t2)),this.retrans=this.retrans+1,this.stack.send(this.lastResponse,this.remote,this.transport)):"H"===t&&(this.setState("TERMINATED"),this.app.timeout(this)):"CONFIRMED"===this.state&&"I"===t&&this.setState("TERMINATED")},InviteServerTransaction.prototype.error=function(t){"PROCEEDING"!==this.state&&"TRYING"!==this.state&&"CONFIRMED"!==this.state||(this.setState("TERMINATED"),this.app.error(this,t))},InviteServerTransaction.prototype.sendResponse=function(t){this.retrans=0,this.lastResponse=t,t.is1xx()?"PROCEEDING"!==this.state&&"TRYING"!==this.state||this.stack.send(t,this.remote,this.transport):"PROCEEDING"!==this.state&&"TRYING"!==this.state||(this.setState("COMPLETED"),this.transport.isReliable()||this.startTimer("G",this.timerconfs.G),this.startTimer("H",this.timerconfs.H),this.stack.send(t,this.remote,this.transport))};var UACore=function(t,e,s,i){if(this.stack=t,this.request=e,this.server=!1,this.transaction=null,this.cancelRequest=null,this.local=null,this.remote=null,this.subject=null,this.secure=!1,this.maxForwards=70,this.routeSet=[],this.localTarget=null,this.remoteTarget=null,this.remoteCandidates=null,this.localSeq=0,this.remoteSeq=0,EXISTS(e)){this.callid=e.callid,this.remote=e.from,this.local=e.to,this.subject=e.subject,this.secure="sips"===e.uri.scheme;var r='"Anonymous" <sip:'+this.local.uri.user+"@r3t1cu1um.invalid;transport=wss>;expires=1800";this.contact=Reticulum.Parser.parseAddress(r)}else this.callid=t.createCallID();this.remoteTag=null,this.localTag=Utils.token(10,Utils.TOKEN_NUMERIC_32),EXISTS(this.local)&&EXISTS(this.local.uri.user)&&(this.contact.uri.user=this.local.uri.user),this.autoack=!1,this.authinfo=i,EXISTS(s)&&(this.server=s)};UACore.prototype.createTransaction=function(t){return Transaction.createServer(this.stack,this,t,this.stack.transport,this.stack.tag,!0)},UACore.prototype.createRequest=function(t,e,s){if(this.server=!1,!EXISTS(this.remote))throw"No remote party for UAC";EXISTS(this.local)||(this.local='"Anonymous" <sip:anonymous@anonymous.invalid>');var i=EXISTS(this.remoteTarget)?this.remoteTarget:this.remote.uri;!this.secure&&i.secure&&(this.secure=!0),"ACK"!==t&&"CANCEL"!==t&&(this.localSeq=this.localSeq+1);var r=new Reticulum.SIP.Message;r.isRequest=!0,r.method=t,r.version="SIP/2.0",r.uri=i,r.addHeader("To",Reticulum.Parser.Enum.SIP_HDR_TO,this.remote.auri),r.to.uri.secure=this.secure,r.addHeader("From",Reticulum.Parser.Enum.SIP_HDR_FROM,this.local.auri),r.from.uri.secure=this.secure,r.from.params.tag=this.localTag,r.addHeader("CSeq",Reticulum.Parser.Enum.SIP_HDR_CSEQ,this.localSeq+" "+t),r.addHeader("Call-ID",Reticulum.Parser.Enum.SIP_HDR_CALL_ID,this.callid);var a=Transaction.createBranch(),n=this.local.uri.user;n='"'+n[0].toUpperCase()+n.substr(1)+' RTC"';var o="SIP/2.0/"+this.stack.transport.protocol.toUpperCase()+" r3t1cu1um.invalid;branch="+a+";rport",u=n+" <sip:"+this.local.uri.user+"@r3t1cu1um.invalid;transport=wss>;expires=1800";if(this.localTarget||(this.localTarget=this.stack.uri(),this.localTarget.user=this.local.uri.user),r.addHeader("Via",Reticulum.Parser.Enum.SIP_HDR_VIA,o),r.addHeader("Contact",Reticulum.Parser.Enum.SIP_HDR_CONTACT,u),"ACK"!==t&&"CANCEL"!==t&&(r.vias[0].params.branch=a),EXISTS(this.routeSet)&&this.routeSet.length>0)for(var c=this.routeSet.length-1;c>=0;c--)r.addHeader("Route",Reticulum.Parser.Enum.SIP_HDR_ROUTE,this.routeSet[c].toString());return s&&r.addHeader("Content-Type",Reticulum.Parser.Enum.SIP_HDR_CONTENT_TYPE,s),r},UACore.prototype.createAck=function(t){var e=null,s=this.stack.requests.getItem(t.id()),i=s.to;EXISTS(t)&&(i=t.to);var r=s.from;return EXISTS(t)&&(r=t.from),e=Message.createRequest("ACK",s.uri),e.addHeader("Call-ID",Reticulum.Parser.Enum.SIP_HDR_CALL_ID,s.callid),e.addHeader("From",Reticulum.Parser.Enum.SIP_HDR_FROM,r.toString()),e.addHeader("To",Reticulum.Parser.Enum.SIP_HDR_TO,i.toString()),e.addHeader("CSeq",Reticulum.Parser.Enum.SIP_HDR_CSEQ,s.cseq.number+" ACK"),e.copyVias(s.vias),EXISTS(s.routes)&&(e.routes=s.routes),e},UACore.prototype.createRegister=function(t){return t&&(this.remote=Reticulum.Parser.parseAddress(t)),this.loca||(this.local=Reticulum.Parser.parseAddress(t)),this.remoteTarget=this.remote.uri.host,this.createRequest("REGISTER")},UACore.prototype.sendRequest=function(t){if(!EXISTS(this.request)&&"REGISTER"===t.method&&EXISTS(this.transaction)&&"COMPLETED"!==this.transaction.state&&"TERMINATED"!==this.transaction.state)throw"Cannot re-REGISTER since pending registration";if(this.request=t,EXISTS(this.routeSet)&&this.routeSet.length>0){t.routes=[];for(var e=this.routeSet.length-1;e>=0;e--)t.addHeader("Route",Reticulum.Parser.Enum.SIP_HDR_ROUTE,this.routeSet[e].toString())}EXISTS(t.routes)&&t.routes.length>0?this.remoteTarget=t.routes[0].uri:this.remoteTarget=t.uri;var s=this.remoteTarget;EXISTS(this.request)||"REGISTER"!==t.method||(t.routes=[]),this.stack.sending(this,t),"ACK"!==this.request.method?this.transaction=Transaction.createClient(this.stack,this,this.request,this.stack.transport,s.hostPort):this.stack.send(this.request,s,this.transport)},UACore.canCreateDialog=function(t,e){return e.is2xx()&&("INVITE"===t.method||"SUBSCRIBE"===t.method)},UACore.prototype.onResponse=function(t,e){if(EXISTS(t)&&t!==this.transaction)return void console.log("Invalid transaction received");if(e.vias.length>1&&console.log("Error. More than one Via header in response"),e.is1xx())if(this.repeated40x=!1,this.cancelRequest){Transaction.createClient(this.stack,this,this.cancelRequest,t.transport,t.remote);this.cancelRequest=null}else this.stack.onResponse(this,e);else if(401===e.statusCode||407===e.statusCode)this.repeated40x?(console.log("Error bad username or password."),this.stack.onResponse(this,e)):this.authenticate(e,this.transaction)?this.repeated40x=!0:this.stack.onResponse(this,e);else if(this.repeated40x=!1,UACore.canCreateDialog(this.request,e)){var s=Dialog.createClient(this.stack,this.request,e,t);this.stack.dialogCreated(s,this),this.stack.onResponse(s,e),this.autoack&&"INVITE"===this.request.method&&s.sendRequest(s.createRequest("ACK"))}else this.stack.onResponse(this,e)},UACore.prototype.onRequest=function(t,e){if(EXISTS(t)&&EXISTS(this.transaction)&&t!==this.transaction&&"CANCEL"!==e.method&&console.log("Invalid transaction for received request"),this.server=!0,EXISTS(e.record_routes)&&(this.routeSet=e.record_routes),-1===["sip","sips","urn"].indexOf(e.uri.scheme))return void t.sendResponse(t.createResponse(416,"Unsupported URI scheme"));if(!EXISTS(e.to.params.tag),EXISTS(t)&&(this.transaction=t),"CANCEL"===e.method){var s=this.stack.findTransaction(Transaction.createId(t.branch,"INVITE"));return EXISTS(s)?(t.sendResponse(t.createResponse(200,"OK")),"PROCEEDING"!==s.state&&"TRYING"!==s.state||s.sendResponse(s.createResponse(487,"Request terminated")),void this.stack.cancelled(this,e)):void t.sendResponse(t.createResponse(481,"Original transaction not found"))}this.stack.onRequest(this,e)},UACore.prototype.sendResponse=function(t,e,s,i,r){if(EXISTS(this.request)||console.log("Invalid request in sending a response"),"number"==typeof t&&(t=this.createResponse(t,responsetext,s,i)),r!==!1&&UACore.canCreateDialog(this.request,t)){if(EXISTS(this.request.record_route)&&(t.record_route=this.request.record_route),!EXISTS(t.contact)){var a=this.contact;if(EXISTS(a.uri.user)||(a.uri.user=this.request.to.uri.user),"Anonymous"===Utils.unquote(a.dname)){var n=this.request.to.uri.user;n=n[0].toUpperCase()+n.substr(1),a.dname='"'+n+' RTC"'}t.addHeader("Contact",Reticulum.Parser.Enum.SIP_HDR_CONTACT,a.toString())}var o=Dialog.createServer(this.stack,this.request,t,this.transaction);this.stack.dialogCreated(o,this),this.stack.sending(o,t)}else this.stack.sending(this,t);EXISTS(this.transaction)?this.transaction.sendResponse(t):this.stack.send(t,t.vias[0].sentby)},UACore.prototype.createResponse=function(t,e,s,i){var r=null;return EXISTS(this.request)||console.log("Invalid request in creating a response"),r=Message.createResponse(t,e,null,s,this.request),i&&r.addHeader("Content-Type",Reticulum.Parser.Enum.SIP_HDR_CONTENT_TYPE,i),s&&r.addHeader("Content-Length",Reticulum.Parser.Enum.SIP_HDR_CONTENT_LENGTH,s.length),100===r.statusCode||EXISTS(r.to.params.tag)||(r.to.params.tag=this.localTag),r},UACore.prototype.sendCancel=function(){EXISTS(this.transaction)||console.log("No transaction for sending CANCEL"),this.cancelRequest=this.transaction.createCancel(),"TRYING"!==this.transaction.state&&"CALLING"!==this.transaction.state&&("PROCEEDING"===this.transaction.state&&(transaction=Transaction.createClient(this.stack,this,this.cancelRequest,this.transaction.transport,this.transaction.remote)),this.cancelRequest=null)},UACore.prototype.timeout=function(t){},UACore.prototype.error=function(t,e){},UACore.prototype.authenticate=function(t,e){if(!EXISTS(t.challenge))return!1;if(!EXISTS(e.request))return!1;var s=Reticulum.Parser.parse(e.request.toString()),i=Digest.createAuthorization(t,s,this.stack.app.authinfo);if(null!==i){var r=t.challenge.proxy?"Proxy-Authorization":"Authorization",a=t.challenge.proxy?Reticulum.Parser.Enum.SIP_HDR_PROXY_AUTHORIZATION:Reticulum.Parser.Enum.SIP_HDR_AUTHORIZATION,n=e.remote;this.localSeq++,s.addHeader(r,a,i),s.addHeader("CSeq",Reticulum.Parser.Enum.SIP_HDR_CSEQ,this.localSeq+" "+s.method),s.vias[0].params.branch=Transaction.createBranch(s);var o=Transaction.createClient(this.stack,this,s,this.stack.transport,n);return this.transaction=o,!0}return console.log("Error creating Authorization"),!1};var Dialog=function(t,e,s,i){UACore.call(this,t,e,s),this.servers=[],this.clients=[],this._id=null,this.closed=!1,EXISTS(i)&&(i.app=this)};Dialog.prototype=Object.create(UACore.prototype),Dialog.prototype.constructor=Dialog,Dialog.createServer=function(t,e,s,i){var r=new Dialog(t,e,!0);return r.request=e,r.routeSet=[],EXISTS(e.record_routes)&&(r.routeSet=e.record_routes),r.secure=!0,r.localSeq=0,r.remoteSeq=e.cseq.number,r.callid=e.callid,r.localTag=s.to.params.tag||"",r.remoteTag=e.from.params.tag||"",r.localParty=e.to,r.remoteParty=e.from,EXISTS(e.contacts)&&e.contacts.length>0&&(r.remoteTarget=e.contacts[0].address.uri),t.dialogs.setItem(r.id(),r),r},Dialog.createClient=function(t,e,s,i){var r=new Dialog(t,e,!1);return r.request=e,r.routeSet=[],EXISTS(s.record_routes)&&(r.routeSet=s.record_routes),r.secure=!0,r.localSeq=e.cseq.number,r.remoteSeq=0,r.callId=e.callid,r.localTag=e.from.params.tag||"",r.remoteTag=s.to.params.tag||"",r.localParty=e.from,r.remoteParty=e.to,EXISTS(s.contacts)&&s.contacts.length>0&&(r.remoteTarget=s.contacts[0].address.uri),t.dialogs.setItem(r.id(),r),r},Dialog.extractId=function(t){return t.isRequest?t.callid+"|"+t.to.params.tag+"|"+t.from.params.tag:t.callid+"|"+t.from.params.tag+"|"+t.to.params.tag},Dialog.prototype.close=function(){if(!this.closed){var t=this.stack.dialogs.getItem(this.id());EXISTS(t)&&t.closed||(EXISTS(t)&&(t.closed=!0),this.closed=!0)}},Dialog.prototype.id=function(){return EXISTS(this._id)||(this._id=this.callid+"|"+this.localTag+"|"+this.remoteTag),this._id},Dialog.prototype.createRequest=function(t,e,s){var i=UACore.prototype.createRequest.call(this,t,e,s);EXISTS(this.remoteTag)&&(i.to.params.tag=this.remoteTag),this.routeSet.length>0&&!EXISTS(this.routeSet[0].uri.params.lr)&&(i.uri=this.routeSet[0].uri);var r=this.localParty.uri.user;r='"'+r[0].toUpperCase()+r.substr(1)+' RTC"';var a=r+" <sip:"+this.localParty.uri.user+"@r3t1cu1um.invalid;transport=wss>;expires=1800";return i.addHeader("Contact",Reticulum.Parser.Enum.SIP_HDR_CONTACT,a),i},Dialog.prototype.createResponse=function(t,e,s,i){0===this.servers.length&&console.log("No server transaction to create response");var r=this.servers[0].request,a=Message.createResponse(t,e,null,s,r);return i&&a.addHeader("Content-Type",Reticulum.Parser.Enum.SIP_HDR_CONTENT_TYPE,i),100===a.statusCode||EXISTS(a.to.params.tag)||(a.to.params.tag=this.localTag),a},Dialog.prototype.sendResponse=function(t,e,s,i,r){void 0===r&&(r=!0),0===this.servers.length&&console.log("No server transaction to send response"),this.transaction=this.servers[0],this.request=this.servers[0].request,UACore.prototype.sendResponse.call(this,t,e,s,i,!1);var a=t;"number"!=typeof t&&(a=t.statusCode),a>=200&&this.servers.shift()},Dialog.prototype.sendCancel=function(){return 0===this.clients.length?void console.log("No client transaction to send cancel"):(this.transaction=this.clients[0],this.request=this.clients[0].request,void UACore.prototype.sendCancel.call(this))},Dialog.prototype.onRequest=function(t,e){if(0!==this.remoteSeq&&e.cseq.number<this.remoteSeq)return console.log("Dialog.onRequest() CSeq is old",e.cseq.number,this.remoteSeq),void this.sendResponse(500,"Internal server error - invalid CSeq");if(this.remoteSeq=e.cseq.number,"INVITE"===e.method&&e.contacts&&(this.remoteTarget=e.contacts[0].address.uri),"ACK"===e.method||"CANCEL"===e.method){var s=this.servers.indexOf(t);return s>-1&&this.servers.splice(s,1),void("ACK"===e.method?this.stack.onRequest(this,e):this.stack.cancelled(this,t.request))}this.servers.push(t),this.stack.onRequest(this,e)},Dialog.prototype.onResponse=function(t,e){if(e.is2xx()&&EXISTS(e.contacts)&&EXISTS(t)&&"INVITE"===t.request.method&&(this.remoteTarget=request.contacts[0].address.uri),!e.is1xx()){var s=this.clients.indexOf(t);s>-1&&this.clients.splice(s,1)}408!==e.statusCode&&481!==e.statusCode||this.close(),401===e.statusCode||407===e.statusCode?this.authenticate(e,t)||this.stack.onResponse(this,e):t&&(this.clients.push(t),this.stack.onResponse(this,e)),this.autoack&&e.is2xx&&(t&&"INVITE"==t.request.method||"INVITE"==e.CSeq.method)&&this.sendRequest(this.createRequest("ACK")),e.is2xx()&&"BYE"===e.method?this.close():e.isFinal()&&"BYE"===e.method&&this.close()};